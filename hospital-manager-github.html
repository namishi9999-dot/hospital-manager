<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="病院管理">
    <meta name="application-name" content="病院顧客管理">
    <meta name="theme-color" content="#1a3a5c">
    <link id="apple-touch-icon" rel="apple-touch-icon" sizes="180x180">
    <link id="favicon" rel="icon" type="image/png" sizes="192x192">
    <title>病院顧客管理 - GitHub連携版</title>
    <script>
    /* アプリアイコン生成 (SVG→Canvas→PNG→apple-touch-icon) */
    (function(){
      var svg='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><defs><linearGradient id="bg" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#1a3a5c"/><stop offset="100%" stop-color="#1a6fc4"/></linearGradient></defs><rect width="512" height="512" rx="80" fill="url(%23bg)"/><rect x="176" y="100" width="160" height="180" rx="16" fill="%23ffffff" opacity="0.95"/><rect x="216" y="80" width="80" height="40" rx="8" fill="%23e0edff"/><rect x="236" y="155" width="40" height="70" fill="%231a6fc4"/><rect x="211" y="180" width="90" height="20" fill="%231a6fc4"/><circle cx="256" cy="355" r="70" fill="%23ffffff" opacity="0.15"/><circle cx="256" cy="355" r="50" fill="none" stroke="%23ffffff" stroke-width="8"/><text x="256" y="372" text-anchor="middle" fill="%23ffffff" font-size="48" font-family="sans-serif" font-weight="bold">+</text><rect x="100" y="310" width="312" height="120" rx="16" fill="%23ffffff" opacity="0.12"/><text x="256" y="385" text-anchor="middle" fill="%23ffffff" font-size="28" font-family="sans-serif" font-weight="bold" opacity="0">M</text></svg>';
      var img=new Image();
      img.onload=function(){
        var c=document.createElement('canvas');c.width=512;c.height=512;
        var ctx=c.getContext('2d');ctx.drawImage(img,0,0);
        var url=c.toDataURL('image/png');
        document.getElementById('apple-touch-icon').href=url;
        document.getElementById('favicon').href=url;
      };
      img.src='data:image/svg+xml;charset=utf-8,'+svg;
    })();
    </script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        :root{--primary:#1a6fc4;--primary-light:#e8f1fa;--secondary:#4a5a8a;--accent:#e67e22;--accent-light:#fef3e6;--success:#27ae60;--success-light:#eafaf1;--danger:#e74c3c;--danger-light:#fdecea;--bg:#f0f2f5;--card:#fff;--text:#1a1a2e;--text-sub:#6b7280;--border:#e2e5ea;--shadow:0 1px 3px rgba(0,0,0,.06),0 1px 2px rgba(0,0,0,.04);--shadow-md:0 4px 12px rgba(0,0,0,.08);--radius:14px}
        body{font-family:-apple-system,BlinkMacSystemFont,'Hiragino Sans','Hiragino Kaku Gothic ProN','Segoe UI',sans-serif;background:var(--bg);color:var(--text);line-height:1.6;overflow-x:hidden;-webkit-font-smoothing:antialiased}
        .header{background:linear-gradient(135deg,#1a3a5c 0%,#1a6fc4 60%,#2980b9 100%);color:#fff;padding:24px 20px 18px;position:sticky;top:0;z-index:100}
        .header h1{font-size:22px;font-weight:800;letter-spacing:-.3px}
        .header-sub{font-size:12px;opacity:.75;margin-top:2px}
        .sync-badge{display:inline-block;margin-top:10px;padding:5px 14px;border-radius:20px;font-size:11px;font-weight:600;background:rgba(255,255,255,.18)}
        .sync-badge.synced{background:rgba(39,174,96,.35)}.sync-badge.syncing{background:rgba(241,196,15,.35)}.sync-badge.error{background:rgba(231,76,60,.35)}
        .tab-bar{display:flex;background:var(--card);border-bottom:1px solid var(--border);position:sticky;top:82px;z-index:99;overflow-x:auto}
        .tab-btn{flex:1;padding:12px 0;text-align:center;background:none;border:none;font-size:11px;font-weight:700;color:var(--text-sub);cursor:pointer;border-bottom:3px solid transparent;transition:all .25s;white-space:nowrap;min-width:0}
        .tab-btn.active{color:var(--primary);border-bottom-color:var(--primary)}
        .container{max-width:720px;margin:0 auto;padding:16px 16px 100px}
        .tab-content{display:none}.tab-content.active{display:block}
        .dash-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:4px}
        .dash-card{background:var(--card);border-radius:var(--radius);padding:18px 14px;text-align:center;cursor:pointer;box-shadow:var(--shadow);border:2px solid transparent;transition:all .2s;position:relative;overflow:hidden}
        .dash-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px}
        .dash-card.c-all::before{background:var(--primary)}.dash-card.c-pref::before{background:var(--secondary)}.dash-card.c-target::before{background:var(--accent)}.dash-card.c-schedule::before{background:#8e44ad}
        .dash-card.selected{border-color:var(--primary);background:var(--primary-light)}
        .dash-card.c-pref.selected{border-color:var(--secondary);background:#eef0f7}
        .dash-card.c-target.selected{border-color:var(--accent);background:var(--accent-light)}
        .dash-card.c-schedule.selected{border-color:#8e44ad;background:#f3e8f9}
        .dash-card:active{transform:scale(.97)}
        .dash-icon{font-size:22px;margin-bottom:4px}.dash-num{font-size:30px;font-weight:800;line-height:1.1}.dash-label{font-size:11px;color:var(--text-sub);font-weight:600;margin-top:4px}
        .view-header{display:flex;align-items:center;justify-content:space-between;padding:16px 0 10px}
        .view-title{font-size:16px;font-weight:800;color:var(--text)}
        .view-count{font-size:12px;color:var(--text-sub);font-weight:600;background:var(--bg);padding:4px 10px;border-radius:12px}
        .search-wrap{margin-bottom:14px;position:relative}
        .search-wrap::before{content:'\01F50D';position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:14px}
        .search-input{width:100%;padding:12px 16px 12px 42px;border:1px solid var(--border);border-radius:12px;font-size:15px;background:var(--card);transition:border-color .2s}
        .search-input:focus{outline:none;border-color:var(--primary)}
        .pref-group{background:var(--card);border-radius:var(--radius);margin-bottom:10px;box-shadow:var(--shadow);overflow:hidden}
        .pref-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;cursor:pointer;font-weight:700;font-size:15px;transition:background .15s;user-select:none}
        .pref-header:active{background:var(--bg)}
        .pref-count{font-size:12px;font-weight:700;color:#fff;background:var(--secondary);padding:2px 10px;border-radius:10px;min-width:30px;text-align:center}
        .pref-arrow{transition:transform .25s;font-size:12px;color:var(--text-sub);margin-left:8px}
        .pref-header.open .pref-arrow{transform:rotate(180deg)}
        .pref-items{display:none;border-top:1px solid var(--border)}.pref-items.open{display:block}
        .h-card{display:flex;align-items:center;padding:14px 16px;cursor:pointer;transition:background .15s;border-bottom:1px solid var(--border)}
        .h-card:last-child{border-bottom:none}.h-card:active{background:#f7f8fa}
        .h-card-standalone{background:var(--card);border-radius:var(--radius);margin-bottom:8px;box-shadow:var(--shadow);display:flex;align-items:center;padding:14px 16px;cursor:pointer;transition:background .15s,transform .15s}
        .h-card-standalone:active{transform:scale(.99);background:#f7f8fa}
        .h-info{flex:1;min-width:0}
        .h-name{font-size:15px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .h-sub{font-size:12px;color:var(--text-sub);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .h-badges{display:flex;gap:4px;margin-left:8px;flex-shrink:0;flex-wrap:wrap}
        .h-badge{font-size:10px;padding:2px 8px;border-radius:8px;font-weight:700;white-space:nowrap}
        .h-badge-target{background:var(--accent-light);color:#b45309}
        .h-chevron{color:var(--border);margin-left:6px;font-size:16px}
        .refresh-bar{display:flex;justify-content:flex-end;margin-bottom:12px}
        .btn-refresh{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:8px 16px;font-size:12px;font-weight:600;color:var(--primary);cursor:pointer;transition:all .2s}
        .btn-refresh:active{background:var(--primary-light)}
        .empty{text-align:center;padding:50px 20px;color:var(--text-sub)}
        .empty-icon{font-size:40px;margin-bottom:10px}.empty-text{font-size:14px}
        .form-card{background:var(--card);border-radius:var(--radius);padding:22px 18px;box-shadow:var(--shadow);margin-bottom:16px}
        .form-card h2{font-size:18px;font-weight:800;margin-bottom:18px}
        .fg{margin-bottom:16px}
        .fl{display:block;font-size:13px;font-weight:700;margin-bottom:6px;color:var(--text)}
        .fi{width:100%;padding:11px 14px;border:1px solid var(--border);border-radius:10px;font-size:15px;background:#fff;transition:border-color .2s}
        .fi:focus{outline:none;border-color:var(--primary)}
        select.fi{appearance:auto}
        .help{font-size:12px;color:var(--text-sub);margin-top:4px}
        .code-inline{background:#f0f0f5;padding:2px 6px;border-radius:4px;font-family:monospace;font-size:12px}
        .chk-row{display:flex;align-items:center;gap:8px;padding:6px 0}
        .chk-row input[type="checkbox"]{width:20px;height:20px;accent-color:var(--primary)}
        .chk-row label{font-size:14px;cursor:pointer;user-select:none}
        .btn{display:block;width:100%;padding:14px;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;transition:all .2s;margin-bottom:8px;text-align:center}
        .btn:active{transform:scale(.98)}
        .btn-primary{background:var(--primary);color:#fff}
        .btn-success{background:var(--success);color:#fff}
        .btn-danger{background:var(--danger);color:#fff}
        .btn-outline{background:#fff;color:var(--primary);border:2px solid var(--primary)}
        .btn-sm{display:inline-block;width:auto;padding:8px 18px;font-size:13px;margin-right:8px}
        .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1000;overflow-y:auto;padding:20px;justify-content:center;align-items:flex-start}
        .modal-overlay.show{display:flex}
        .modal-box{background:var(--card);border-radius:var(--radius);padding:22px 18px;max-width:620px;width:100%;margin:auto;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.2)}
        .modal-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
        .modal-title{font-size:18px;font-weight:800;color:var(--primary)}
        .modal-x{background:none;border:none;font-size:26px;color:var(--text-sub);cursor:pointer;padding:0;line-height:1}
        .detail-row{display:flex;padding:10px 0;border-bottom:1px solid var(--border);font-size:14px}
        .detail-row:last-child{border-bottom:none}
        .detail-lbl{font-weight:700;color:var(--text-sub);min-width:130px;flex-shrink:0}
        .detail-val{color:var(--text);word-break:break-all}
        .detail-badges{display:flex;gap:6px;flex-wrap:wrap;margin:10px 0}
        .modal-actions{display:flex;gap:8px;margin-top:16px}
        .toast{position:fixed;top:90px;left:50%;transform:translateX(-50%) translateY(-20px);background:var(--card);padding:12px 24px;border-radius:12px;box-shadow:var(--shadow-md);z-index:2000;opacity:0;pointer-events:none;transition:all .3s;font-size:14px;font-weight:600;max-width:90%;text-align:center}
        .toast.show{opacity:1;transform:translateX(-50%) translateY(0);pointer-events:auto}
        .toast.success{border-left:4px solid var(--success)}.toast.error{border-left:4px solid var(--danger)}
        textarea.fi{font-family:inherit;min-height:90px;resize:vertical}
        .sub-tab-bar{display:flex;gap:8px;margin-bottom:16px}
        .sub-tab-btn{flex:1;padding:10px;text-align:center;background:var(--card);border:2px solid var(--border);border-radius:10px;font-size:12px;font-weight:700;color:var(--text-sub);cursor:pointer;transition:all .2s}
        .sub-tab-btn.active{border-color:var(--primary);color:var(--primary);background:var(--primary-light)}
        .tag-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
        .tag-item{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:var(--bg);border-radius:20px;font-size:13px;font-weight:600}
        .tag-del{background:none;border:none;color:var(--danger);font-size:16px;cursor:pointer;line-height:1;padding:0}
        .sched-table{width:100%;border-collapse:collapse;font-size:12px;margin-top:10px}
        .sched-table th,.sched-table td{border:1px solid var(--border);padding:4px;text-align:center;vertical-align:middle}
        .sched-table th{background:var(--bg);font-weight:700;font-size:11px}
        .sched-table select{width:100%;font-size:11px;padding:2px;border:1px solid var(--border);border-radius:4px;background:#fff}
        .sched-day-header{background:var(--primary-light)!important;font-weight:800}
        .filter-grid{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0 14px}
        .filter-chk{display:flex;align-items:center;gap:4px;padding:4px 10px;background:var(--card);border:1px solid var(--border);border-radius:8px;font-size:12px;cursor:pointer;user-select:none}
        .filter-chk input{width:16px;height:16px;accent-color:var(--primary)}
        .filter-chk.checked{border-color:var(--primary);background:var(--primary-light)}
        .inline-add{display:flex;gap:8px;margin-bottom:8px}
        .inline-add input{flex:1}
        .inline-add button{padding:10px 18px;border:none;border-radius:10px;background:var(--primary);color:#fff;font-size:13px;font-weight:700;cursor:pointer;white-space:nowrap}
        .staff-section{margin-top:16px;padding-top:14px;border-top:2px solid var(--border)}
        .staff-section h3{font-size:15px;font-weight:800;margin-bottom:10px;color:var(--secondary)}
        .staff-mini-card{display:flex;align-items:center;padding:8px 12px;background:var(--bg);border-radius:10px;margin-bottom:6px;font-size:13px}
        .staff-mini-card .s-name{font-weight:700;margin-right:8px}
        .staff-mini-card .s-type{color:var(--text-sub);font-size:12px}
        .tag-search-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin: 10px 0;
        }
        .tag-search-chk {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 10px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            user-select: none;
        }
        .tag-search-chk input {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
        }
        .tag-search-chk.checked {
            border-color: var(--primary);
            background: var(--primary-light);
        }
        .dash-card.c-tagsearch::before {
            background: #16a34a;
        }
        .dash-card.c-tagsearch.selected {
            border-color: #16a34a;
            background: #f0fdf4;
        }
        /* Calendar */
        .cal-nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
        .cal-nav span{font-size:18px;font-weight:800}
        .cal-grid{width:100%;border-collapse:collapse}
        .cal-grid th{padding:6px;text-align:center;font-size:12px;font-weight:700}
        .cal-grid td{padding:2px;text-align:center;vertical-align:top;height:52px;cursor:pointer;border-radius:8px}
        .cal-grid td:hover{background:var(--bg)}
        .cal-grid td.today{background:var(--primary-light);font-weight:800}
        .cal-grid td.selected{background:var(--primary);color:#fff;border-radius:8px}
        .cal-grid td.selected:hover{background:var(--primary)}
        .cal-dot{width:6px;height:6px;border-radius:50%;margin:1px auto 0;display:inline-block}
        .cal-dot.cand{background:var(--accent)}.cal-dot.conf{background:var(--success)}
        .appt-card{background:var(--card);border-radius:var(--radius);padding:12px 14px;box-shadow:var(--shadow);margin-bottom:8px;border-left:4px solid var(--accent)}
        .appt-card.confirmed{border-left-color:var(--success)}
        .appt-top{display:flex;justify-content:space-between;align-items:center}
        .appt-title{font-weight:800;font-size:15px}
        .appt-time{font-size:14px;font-weight:700;color:var(--primary)}
        .appt-meta{font-size:12px;color:var(--text-sub);margin-top:4px}
        .appt-actions{margin-top:8px;display:flex;gap:6px;flex-wrap:wrap}
        .status-badge{display:inline-block;padding:2px 10px;border-radius:8px;font-size:10px;font-weight:700;margin-left:8px}
        .status-cand{background:var(--accent-light);color:#b45309}
        .status-conf{background:var(--success-light);color:#1a8a4a}
        @media(max-width:400px){.dash-num{font-size:26px}.h-name{font-size:14px}.tab-btn{font-size:10px;padding:10px 2px}}
    </style>
</head>
<body>
<div class="header">
    <h1>&#x1F3E5; 病院顧客管理</h1>
    <div class="header-sub">GitHub連携版 v7.0</div>
    <div class="sync-badge" id="syncStatus">未接続</div>
</div>
<div class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('list',this)">&#x1F4CB; 病院一覧</button>
    <button class="tab-btn" onclick="switchTab('staff',this)">&#x1F464; 従事者</button>
    <button class="tab-btn" onclick="switchTab('calendar',this)">&#x1F4C5; カレンダー</button>
    <button class="tab-btn" onclick="switchTab('add',this)">&#x2795; 追加</button>
    <button class="tab-btn" onclick="switchTab('setup',this)">&#x2699;&#xFE0F; 設定</button>
</div>
<div class="toast" id="toast"></div>

<!-- Modals -->
<div class="modal-overlay" id="detailModal"><div class="modal-box"><div class="modal-top"><div class="modal-title">施設詳細</div><button class="modal-x" onclick="closeModal('detailModal')">&times;</button></div><div id="detailBody"></div><div class="modal-actions"><button class="btn btn-primary btn-sm" onclick="openEditFromDetail()">&#x270F;&#xFE0F; 編集</button><button class="btn btn-danger btn-sm" onclick="deleteFromDetail()">&#x1F5D1; 削除</button></div></div></div>
<div class="modal-overlay" id="editModal"><div class="modal-box"><div class="modal-top"><div class="modal-title">施設情報の編集</div><button class="modal-x" onclick="closeModal('editModal')">&times;</button></div><div id="editFormWrap"></div></div></div>
<div class="modal-overlay" id="staffDetailModal"><div class="modal-box"><div class="modal-top"><div class="modal-title">医療従事者詳細</div><button class="modal-x" onclick="closeModal('staffDetailModal')">&times;</button></div><div id="staffDetailBody"></div><div class="modal-actions"><button class="btn btn-primary btn-sm" onclick="openStaffEditFromDetail()">&#x270F;&#xFE0F; 編集</button><button class="btn btn-danger btn-sm" onclick="deleteStaffFromDetail()">&#x1F5D1; 削除</button></div></div></div>
<div class="modal-overlay" id="staffEditModal"><div class="modal-box"><div class="modal-top"><div class="modal-title">医療従事者の編集</div><button class="modal-x" onclick="closeModal('staffEditModal')">&times;</button></div><div id="staffEditFormWrap"></div></div></div>
<div class="modal-overlay" id="scheduleModal"><div class="modal-box" style="max-width:700px"><div class="modal-top"><div class="modal-title">外来スケジュール</div><button class="modal-x" onclick="closeModal('scheduleModal')">&times;</button></div><div id="scheduleBody"></div></div></div>
<div class="modal-overlay" id="appointmentModal"><div class="modal-box"><div class="modal-top"><div class="modal-title" id="apptModalTitle">予定の追加</div><button class="modal-x" onclick="closeModal('appointmentModal')">&times;</button></div><div id="apptFormWrap"></div></div></div>

<div class="container">
<div id="tab-list" class="tab-content active"><div class="dash-grid" id="dashGrid"></div><div id="listSubView"></div></div>
<div id="tab-staff" class="tab-content"><div class="view-header"><div class="view-title">医療従事者一覧</div><div class="view-count" id="staffCount">0件</div></div><div class="search-wrap"><input type="text" class="search-input" id="staffSearch" placeholder="名前・病院名・職種で検索..."></div><div id="staffList"></div></div>
<div id="tab-calendar" class="tab-content"><div id="calendarView"></div></div>
<div id="tab-add" class="tab-content">
    <div class="sub-tab-bar">
        <button class="sub-tab-btn active" onclick="switchAddSub('hospital',this)">&#x1F3E5; 施設</button>
        <button class="sub-tab-btn" onclick="switchAddSub('staffadd',this)">&#x1F464; 従事者</button>
        <button class="sub-tab-btn" onclick="switchAddSub('apptadd',this)">&#x1F4C5; 予定</button>
    </div>
    <div id="sub-hospital" class="tab-content active">
        <div class="form-card"><h2>新規施設の登録</h2>
            <div class="fg"><label class="fl">施設名 *</label><input type="text" class="fi" id="inp-name"></div>
            <div class="fg"><label class="fl">都道府県 *</label><input type="text" class="fi" id="inp-pref"></div>
            <div class="fg"><label class="fl">市町村 *</label><input type="text" class="fi" id="inp-city"></div>
            <div class="fg"><label class="fl">住所（詳細）</label><input type="text" class="fi" id="inp-addr"></div>
            <div class="fg"><label class="fl">代表電話番号</label><input type="tel" class="fi" id="inp-phone"></div>
            <div class="fg"><label class="fl">病床数</label><input type="number" class="fi" id="inp-bedcount" min="0"></div>
            <div class="fg"><label class="fl">ICU病床数</label><input type="number" class="fi" id="inp-icubeds" min="0"></div>
            <div class="fg"><label class="fl">透析室病床数</label><input type="number" class="fi" id="inp-dialysisbeds" min="0"></div>
            <div class="fg"><label class="fl">透析患者数</label><input type="number" class="fi" id="inp-dialysispatients" min="0"></div>
            <div class="fg"><label class="fl">透析装置更新年度</label><input type="text" class="fi" id="inp-renewalyear" placeholder="例: 2025"></div>
            <div class="fg"><label class="fl">その他</label><input type="text" class="fi" id="inp-other"></div>
            <div class="fg"><label class="fl">メモ</label><textarea class="fi" id="inp-memo"></textarea></div>
            <div class="fg"><label class="fl">ターゲット分類</label><div id="inp-targets-wrap"></div></div>
            <button class="btn btn-success" onclick="addHospital()">&#x2705; 登録する</button>
        </div>
    </div>
    <div id="sub-staffadd" class="tab-content">
        <div class="form-card"><h2>新規医療従事者の登録</h2>
            <div class="fg"><label class="fl">氏名 *</label><input type="text" class="fi" id="inp-sname"></div>
            <div class="fg"><label class="fl">所属施設 *</label><select class="fi" id="inp-shospital"></select></div>
            <div class="fg"><label class="fl">職種 *</label><select class="fi" id="inp-sjobtype"></select></div>
            <div class="fg"><label class="fl">電話番号</label><input type="tel" class="fi" id="inp-sphone"></div>
            <div class="fg"><label class="fl">メールアドレス</label><input type="email" class="fi" id="inp-semail"></div>
            <div class="fg"><label class="fl">メモ</label><textarea class="fi" id="inp-smemo"></textarea></div>
            <button class="btn btn-success" onclick="addStaff()">&#x2705; 登録する</button>
        </div>
    </div>
    <div id="sub-apptadd" class="tab-content">
        <div class="form-card"><h2>新規予定の登録</h2>
            <div class="fg"><label class="fl">タイトル *</label><input type="text" class="fi" id="inp-atitle"></div>
            <div class="fg"><label class="fl">施設</label><select class="fi" id="inp-ahospital" onchange="onInpAHospChange()"></select></div>
            <div class="fg"><label class="fl">担当者</label><select class="fi" id="inp-astaff"></select></div>
            <div class="fg"><label class="fl">日付 *</label><input type="date" class="fi" id="inp-adate"></div>
            <div class="fg"><label class="fl">時間</label><input type="time" class="fi" id="inp-atime"></div>
            <div class="fg"><label class="fl">ステータス</label><select class="fi" id="inp-astatus"><option value="candidate">候補</option><option value="confirmed">確定</option></select></div>
            <div class="fg"><label class="fl">メモ</label><textarea class="fi" id="inp-anotes"></textarea></div>
            <button class="btn btn-success" onclick="addApptFromTab()">&#x2705; 登録する</button>
        </div>
    </div>
</div>
<div id="tab-setup" class="tab-content">
    <div class="form-card"><h2>GitHub連携設定</h2>
        <p class="help" style="margin-bottom:18px">GitHubと連携して、PCとiPhoneでデータを自動同期します。</p>
        <div class="fg"><label class="fl">GitHubユーザー名</label><input type="text" class="fi" id="cfgUser" placeholder="your-username"></div>
        <div class="fg"><label class="fl">リポジトリ名</label><input type="text" class="fi" id="cfgRepo" value="hospital-manager"></div>
        <div class="fg"><label class="fl">Personal Access Token</label><input type="password" class="fi" id="cfgToken" placeholder="ghp_xxxxxxxxxxxxx"><div class="help">GitHub &rarr; Settings &rarr; Developer settings &rarr; Personal access tokens &rarr; Tokens (classic)<br>権限: <span class="code-inline">repo</span> にチェック</div></div>
        <button class="btn btn-primary" onclick="saveCfg()">&#x1F4BE; 設定を保存</button>
        <button class="btn btn-success" onclick="testConn()">&#x1F50C; 接続テスト</button>
    </div>
    <div class="form-card"><h2>ターゲット分類の管理</h2>
        <p class="help" style="margin-bottom:12px">施設に設定できるターゲット分類を管理します。</p>
        <div class="inline-add"><input type="text" class="fi" id="newTargetName" placeholder="ターゲット名を入力..."><button onclick="addTarget()">追加</button></div>
        <div class="tag-list" id="targetTagList"></div>
    </div>
    <div class="form-card"><h2>職種の管理</h2>
        <p class="help" style="margin-bottom:12px">医療従事者に設定できる職種を管理します。</p>
        <div class="inline-add"><input type="text" class="fi" id="newJobTypeName" placeholder="職種名を入力..."><button onclick="addJobType()">追加</button></div>
        <div class="tag-list" id="jobTypeTagList"></div>
    </div>
    <div class="form-card"><h2>CSVエクスポート</h2>
        <p class="help" style="margin-bottom:12px">データをCSVファイルとしてダウンロードします。</p>
        <button class="btn btn-primary" onclick="exportCSV('hospitals')">&#x1F4E5; 施設データCSV</button>
        <button class="btn btn-primary" onclick="exportCSV('staff')">&#x1F4E5; 医療従事者CSV</button>
        <button class="btn btn-primary" onclick="exportCSV('appointments')">&#x1F4E5; アポイントCSV</button>
        <div id="exportMailLink" style="display:none;margin-top:12px"></div>
    </div>
    <div class="form-card"><h2>CSVインポート</h2>
        <p class="help" style="margin-bottom:12px">編集済みCSVをアップロードしてデータを上書きします。</p>
        <div class="fg"><label class="fl">施設データ (hospitals.csv)</label><input type="file" class="fi" id="importHospFile" accept=".csv" style="padding:8px"><button class="btn btn-primary btn-sm" style="margin-top:8px" onclick="importCSV('hospitals')">&#x1F4E4; インポート</button></div>
        <div class="fg"><label class="fl">医療従事者 (staff.csv)</label><input type="file" class="fi" id="importStaffFile" accept=".csv" style="padding:8px"><button class="btn btn-primary btn-sm" style="margin-top:8px" onclick="importCSV('staff')">&#x1F4E4; インポート</button></div>
        <div class="fg"><label class="fl">アポイント (appointments.csv)</label><input type="file" class="fi" id="importApptFile" accept=".csv" style="padding:8px"><button class="btn btn-primary btn-sm" style="margin-top:8px" onclick="importCSV('appointments')">&#x1F4E4; インポート</button></div>
    </div>
</div>
</div>

<script>
/* === STATE === */
var hospitals=[],staffMembers=[],targets=[],jobTypes=[],schedules=[],appointments=[];
var cfg=null,currentIdx=-1,currentStaffIdx=-1,currentView=null,dataLoaded=false,openPrefs={};
var calendarDate=new Date(),calendarSelectedDate=null,editingApptId=null;

/* === UTIL === */
function esc(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;')}
function toast(m,t){t=t||'success';var e=document.getElementById('toast');e.textContent=m;e.className='toast '+t+' show';if(toast._t)clearTimeout(toast._t);toast._t=setTimeout(function(){e.classList.remove('show')},2500)}
function syncBadge(c,t){var e=document.getElementById('syncStatus');e.className='sync-badge '+c;e.textContent=t}
function genId(){return Date.now().toString(36)+Math.random().toString(36).substr(2,5)}
function pad2(n){return n<10?'0'+n:''+n}
function closeModal(id){document.getElementById(id).classList.remove('show')}

/* === TABS === */
function switchTab(n,el){
    if(n==='dash'){
        /* タグ検索カードをクリックしたとき: tab-listタブをアクティブにしてからタグ検索ビューを表示 */
        document.querySelectorAll('.tab-bar .tab-btn').forEach(function(b){b.classList.remove('active')});
        var listBtn=document.querySelector('.tab-bar .tab-btn[onclick*="list"]');
        if(listBtn)listBtn.classList.add('active');
        document.querySelectorAll('.container>.tab-content').forEach(function(c){c.classList.remove('active')});
        document.getElementById('tab-list').classList.add('active');
        currentView='tagsearch';
        renderDash();
        renderTagSearchView();
        return;
    }
    document.querySelectorAll('.tab-bar .tab-btn').forEach(function(b){b.classList.remove('active')});if(el)el.classList.add('active');
    document.querySelectorAll('.container>.tab-content').forEach(function(c){c.classList.remove('active')});
    document.getElementById('tab-'+n).classList.add('active');
    if(n==='list'){if(!dataLoaded&&cfg)loadAllFromGitHub();else{renderDash();renderSubView()}}
    if(n==='staff')renderStaffList();
    if(n==='calendar')renderCalendar();
    if(n==='add')refreshAddSelects();
    if(n==='setup'){renderTargetTags();renderJobTypeTags()}
}
function switchAddSub(n,el){
    el.parentElement.querySelectorAll('.sub-tab-btn').forEach(function(b){b.classList.remove('active')});el.classList.add('active');
    ['hospital','staffadd','apptadd'].forEach(function(s){document.getElementById('sub-'+s).classList.remove('active')});
    document.getElementById('sub-'+n).classList.add('active');refreshAddSelects();
}

/* === GITHUB === */
function saveCfg(){var c={username:document.getElementById('cfgUser').value.trim(),repo:document.getElementById('cfgRepo').value.trim(),token:document.getElementById('cfgToken').value.trim()};if(!c.username||!c.repo||!c.token){toast('すべての項目を入力してください','error');return}localStorage.setItem('ghCfg',JSON.stringify(c));cfg=c;toast('設定を保存しました');syncBadge('synced','設定保存済み')}
function loadCfg(){var s=localStorage.getItem('ghCfg');if(s){cfg=JSON.parse(s);document.getElementById('cfgUser').value=cfg.username;document.getElementById('cfgRepo').value=cfg.repo;document.getElementById('cfgToken').value=cfg.token;syncBadge('synced','設定済み')}}
function testConn(){if(!cfg){toast('まず設定を保存してください','error');return}syncBadge('syncing','接続中...');ghFetch('').then(function(r){if(r.ok){toast('接続成功！');syncBadge('synced','接続成功')}else{toast('接続失敗','error');syncBadge('error','接続失敗')}}).catch(function(){toast('接続失敗','error');syncBadge('error','接続失敗')})}
function ghFetch(p,o){var u='https://api.github.com/repos/'+cfg.username+'/'+cfg.repo+(p?'/'+p:'');var h={'Authorization':'token '+cfg.token,'Accept':'application/vnd.github.v3+json'};return fetch(u,Object.assign({headers:h},o||{}))}
function ghGetFile(f){return ghFetch('contents/'+f).then(function(r){if(!r.ok)return null;return r.json()}).catch(function(){return null})}
function ghPutFile(f,c,sha){var b={message:'Update '+f,content:btoa(unescape(encodeURIComponent(c)))};if(sha)b.sha=sha;return ghFetch('contents/'+f,{method:'PUT',headers:{'Authorization':'token '+cfg.token,'Accept':'application/vnd.github.v3+json','Content-Type':'application/json'},body:JSON.stringify(b)})}
function loadAllFromGitHub(){if(!cfg)return;syncBadge('syncing','読み込み中...');Promise.all([ghGetFile('hospitals.csv'),ghGetFile('staff.csv'),ghGetFile('targets.csv'),ghGetFile('jobtypes.csv'),ghGetFile('schedules.csv'),ghGetFile('appointments.csv')]).then(function(R){
    function dec(r){return decodeURIComponent(escape(atob(r.content.replace(/\n/g,''))))}
    if(R[0])parseHospitalsCSV(dec(R[0]));if(R[1])parseStaffCSV(dec(R[1]));if(R[2])parseTargetsCSV(dec(R[2]));
    if(R[3])parseJobTypesCSV(dec(R[3]));else if(!jobTypes.length)jobTypes=['ドクター','看護師','臨床工学技士'];
    if(R[4])parseSchedulesCSV(dec(R[4]));if(R[5])parseAppointmentsCSV(dec(R[5]));
    dataLoaded=true;syncBadge('synced','同期完了');renderDash();renderSubView();renderTargetTags();renderJobTypeTags();
}).catch(function(e){syncBadge('error','読み込みエラー');toast('読み込み失敗: '+e.message,'error');renderDash();renderSubView()})}
function ghSave(fname,content){if(!cfg)return Promise.resolve(false);return ghGetFile(fname).then(function(d){return ghPutFile(fname,content,d?d.sha:null)}).then(function(r){if(!r.ok)throw new Error('fail');return true}).catch(function(e){toast(fname+'保存失敗','error');return false})}
function saveH(){syncBadge('syncing','保存中...');ghSave('hospitals.csv',genHospCSV()).then(function(){syncBadge('synced','同期完了')})}
function saveS(){ghSave('staff.csv',genStaffCSV())}
function saveT(){ghSave('targets.csv',genTargetsCSV())}
function saveJ(){ghSave('jobtypes.csv',genJobTypesCSV())}
function saveSch(){ghSave('schedules.csv',genSchedCSV())}
function saveA(){ghSave('appointments.csv',genApptCSV())}
function refreshGH(){if(!cfg){toast('GitHub設定を完了してください','error');return}dataLoaded=false;loadAllFromGitHub();toast('最新データを取得しています...')}

/* === CSV HELPERS === */
function csvLine(l){var r=[],c='',q=false;for(var i=0;i<l.length;i++){var ch=l[i];if(ch==='"'){if(q&&l[i+1]==='"'){c+='"';i++}else q=!q}else if(ch===','&&!q){r.push(c.trim());c=''}else c+=ch}r.push(c.trim());return r}
function csvE(v){if(!v)return'';var s=String(v);return(s.indexOf(',')>=0||s.indexOf('"')>=0||s.indexOf('\n')>=0)?'"'+s.replace(/"/g,'""')+'"':s}

/* === HOSPITALS CSV === */
function parseHospitalsCSV(t){var ls=t.split('\n').filter(function(l){return l.trim()});if(!ls.length)return;var hd=csvLine(ls[0]);hospitals=[];var M={'病院名':'Name','住所':'Address','都道府県':'Prefecture','市町村':'City','代表電話番号':'Phone','その他':'Other','メモ':'Memo','ターゲット':'Targets','病床数':'BedCount','ICU病床数':'ICUBeds','透析室病床数':'DialysisBeds','透析患者数':'DialysisPatients','透析装置更新年度':'DialysisRenewalYear'};for(var i=1;i<ls.length;i++){var vs=csvLine(ls[i]),h={};hd.forEach(function(k,j){h[M[k]||k]=vs[j]||''});if(h.IsTarget==='Yes'&&!h.Targets)h.Targets='ターゲット';delete h.Doctors;delete h.Nurses;delete h.Engineers;delete h.HasOutpatient;delete h.IsTarget;hospitals.push(h)}}
function genHospCSV(){var o='Name,Address,Prefecture,City,Phone,Other,Memo,Targets,BedCount,ICUBeds,DialysisBeds,DialysisPatients,DialysisRenewalYear\n';hospitals.forEach(function(h){o+=[h.Name,h.Address,h.Prefecture,h.City,h.Phone,h.Other,h.Memo,h.Targets,h.BedCount,h.ICUBeds,h.DialysisBeds,h.DialysisPatients,h.DialysisRenewalYear].map(function(v){return csvE(v||'')}).join(',')+'\n'});return o}

/* === STAFF CSV === */
function parseStaffCSV(t){var ls=t.split('\n').filter(function(l){return l.trim()});if(!ls.length)return;var hd=csvLine(ls[0]);staffMembers=[];for(var i=1;i<ls.length;i++){var vs=csvLine(ls[i]),s={};hd.forEach(function(k,j){s[k]=vs[j]||''});staffMembers.push(s)}}
function genStaffCSV(){var o='ID,Name,HospitalName,JobType,Phone,Email,Memo\n';staffMembers.forEach(function(s){o+=[s.ID,s.Name,s.HospitalName,s.JobType,s.Phone,s.Email,s.Memo].map(function(v){return csvE(v||'')}).join(',')+'\n'});return o}

/* === TARGETS/JOBTYPES CSV === */
function parseTargetsCSV(t){targets=[];t.split('\n').forEach(function(l){var n=l.trim();if(n&&n!=='Name')targets.push(n)})}
function genTargetsCSV(){var o='Name\n';targets.forEach(function(t){o+=csvE(t)+'\n'});return o}
function parseJobTypesCSV(t){jobTypes=[];t.split('\n').forEach(function(l){var n=l.trim();if(n&&n!=='Name')jobTypes.push(n)});if(!jobTypes.length)jobTypes=['ドクター','看護師','臨床工学技士']}
function genJobTypesCSV(){var o='Name\n';jobTypes.forEach(function(j){o+=csvE(j)+'\n'});return o}

/* === SCHEDULES CSV === */
function parseSchedulesCSV(t){var ls=t.split('\n').filter(function(l){return l.trim()});if(!ls.length)return;var hd=csvLine(ls[0]);schedules=[];for(var i=1;i<ls.length;i++){var vs=csvLine(ls[i]),s={};hd.forEach(function(k,j){s[k]=vs[j]||''});schedules.push(s)}}
function genSchedCSV(){var o='HospitalName,DayOfWeek,Period,Slot,StaffName\n';schedules.forEach(function(s){o+=[s.HospitalName,s.DayOfWeek,s.Period,s.Slot,s.StaffName].map(function(v){return csvE(v||'')}).join(',')+'\n'});return o}

/* === APPOINTMENTS CSV === */
function parseAppointmentsCSV(t){var ls=t.split('\n').filter(function(l){return l.trim()});if(!ls.length)return;var hd=csvLine(ls[0]);appointments=[];for(var i=1;i<ls.length;i++){var vs=csvLine(ls[i]),a={};hd.forEach(function(k,j){a[k]=vs[j]||''});appointments.push(a)}}
function genApptCSV(){var o='ID,Title,HospitalName,StaffName,Date,Time,Status,Notes\n';appointments.forEach(function(a){o+=[a.ID,a.Title,a.HospitalName,a.StaffName,a.Date,a.Time,a.Status,a.Notes].map(function(v){return csvE(v||'')}).join(',')+'\n'});return o}

/* === TARGETS MGMT === */
function renderTargetTags(){var w=document.getElementById('targetTagList');if(!w)return;if(!targets.length){w.innerHTML='<span class="help">ターゲットが未登録です</span>';return}var h='';targets.forEach(function(t,i){h+='<span class="tag-item">'+esc(t)+'<button class="tag-del" onclick="removeTarget('+i+')">&times;</button></span>'});w.innerHTML=h}
function addTarget(){var inp=document.getElementById('newTargetName'),n=inp.value.trim();if(!n){toast('ターゲット名を入力してください','error');return}if(targets.indexOf(n)>=0){toast('同じ名前が存在します','error');return}targets.push(n);inp.value='';renderTargetTags();if(cfg)saveT();toast('ターゲット「'+n+'」を追加しました')}
function removeTarget(i){var n=targets[i];targets.splice(i,1);renderTargetTags();if(cfg)saveT();toast('ターゲット「'+n+'」を削除しました')}

/* === JOBTYPES MGMT === */
function renderJobTypeTags(){var w=document.getElementById('jobTypeTagList');if(!w)return;if(!jobTypes.length){w.innerHTML='<span class="help">職種が未登録です</span>';return}var h='';jobTypes.forEach(function(j,i){h+='<span class="tag-item">'+esc(j)+'<button class="tag-del" onclick="removeJobType('+i+')">&times;</button></span>'});w.innerHTML=h}
function addJobType(){var inp=document.getElementById('newJobTypeName'),n=inp.value.trim();if(!n){toast('職種名を入力してください','error');return}if(jobTypes.indexOf(n)>=0){toast('同じ名前が存在します','error');return}jobTypes.push(n);inp.value='';renderJobTypeTags();if(cfg)saveJ();toast('職種「'+n+'」を追加しました')}
function removeJobType(i){var n=jobTypes[i];jobTypes.splice(i,1);renderJobTypeTags();if(cfg)saveJ();toast('職種「'+n+'」を削除しました')}

/* === DASHBOARD === */
function renderDash(){
    var total=hospitals.length,prefSet={};hospitals.forEach(function(h){if(h.Prefecture)prefSet[h.Prefecture]=true});var prefCount=Object.keys(prefSet).length;
    var html='<div class="dash-card c-all '+(currentView==='all'?'selected':'')+'" onclick="setView(\'all\')"><div class="dash-icon">&#x1F3E5;</div><div class="dash-num">'+total+'</div><div class="dash-label">全施設</div></div>';
    html+='<div class="dash-card c-pref '+(currentView==='pref'?'selected':'')+'" onclick="setView(\'pref\')"><div class="dash-icon">&#x1F4CD;</div><div class="dash-num">'+prefCount+'</div><div class="dash-label">都道府県別</div></div>';
    html+='<div class="dash-card c-tagsearch '+(currentView==='tagsearch'?'selected':'')+'" onclick="currentView=\'tagsearch\'; switchTab(\'dash\');"><div class="dash-icon">&#x1F3F7;</div><div class="dash-label">タグ検索</div></div>';
    var shSet={};schedules.forEach(function(s){if(s.StaffName)shSet[s.HospitalName]=true});
    html+='<div class="dash-card c-schedule '+(currentView==='schedule'?'selected':'')+'" onclick="setView(\'schedule\')"><div class="dash-icon">&#x1F4C5;</div><div class="dash-num">'+Object.keys(shSet).length+'</div><div class="dash-label">外来予定</div></div>';
    document.getElementById('dashGrid').innerHTML=html;
}
function getTargets(h){return(h.Targets||'').split(';').map(function(x){return x.trim()}).filter(Boolean)}
function setView(v){currentView=v;renderDash();renderSubView()}

/* === TAG SEARCH VIEW === */
function renderTagSearchView(){
  var html='<div class="view-header"><div class="view-title">&#x1F3F7; タグ検索</div><div class="view-count">複数タグでAND検索</div></div>';
  html+='<div class="form-card" style="margin-bottom:12px"><label class="fl">タグを選択してください</label>';
  if(targets.length===0){
    html+='<div class="empty" style="padding:20px 0"><div class="empty-icon">&#x1F3F7;</div><div class="empty-text" style="font-size:13px">タグが登録されていません<br><span style="color:var(--primary)">⚙️ 設定タブ</span>からタグを追加してください</div></div>';
  }else{
    html+='<div class="tag-search-grid" id="tagSearchFilter">';
    targets.forEach(function(t){
      html+='<label class="tag-search-chk"><input type="checkbox" value="'+esc(t)+'" onchange="renderTagSearchResults()"> '+esc(t)+'</label>'
    });
    html+='</div>';
  }
  html+='</div>';
  html+='<div id="tagSearchResults"></div>';
  document.getElementById('listSubView').innerHTML=html;
  if(targets.length>0)renderTagSearchResults();
}

function renderTagSearchResults(){
  var selTargets=[];
  document.querySelectorAll('#tagSearchFilter input:checked').forEach(function(c){
    selTargets.push(c.value);
    c.parentElement.classList.add('checked');
  });
  document.querySelectorAll('#tagSearchFilter input:not(:checked)').forEach(function(c){
    c.parentElement.classList.remove('checked');
  });

  var w=document.getElementById('tagSearchResults');
  if(!w)return;

  /* タグ未選択のときはプロンプトを表示（施設一覧は表示しない） */
  if(selTargets.length===0){
    w.innerHTML='<div class="empty"><div class="empty-icon">&#x2B06;</div><div class="empty-text">上のタグを選択すると<br>該当する施設が表示されます</div></div>';
    return;
  }

  var filtered=[];
  hospitals.forEach(function(h,i){
    var hTargets=getTargets(h);
    if(selTargets.every(function(st){return hTargets.indexOf(st)>=0})){
      filtered.push({h:h,idx:i});
    }
  });

  if(filtered.length===0){
    w.innerHTML='<div class="empty"><div class="empty-icon">&#x1F50D;</div><div class="empty-text">該当する施設がありません</div></div>';
    return;
  }
  var html='<div class="view-count" style="margin-bottom:12px">'+filtered.length+'件</div>';
  filtered.forEach(function(item){html+=cardStandalone(item.h,item.idx)});
  w.innerHTML=html;
}

/* === SUB VIEWS === */
function renderSubView(){
    var w=document.getElementById('listSubView');
    if(!currentView){w.innerHTML='<div class="empty"><div class="empty-icon">&#x1F446;</div><div class="empty-text">上のカードをタップして<br>施設一覧を表示してください</div></div>';return}
    if(currentView==='tagsearch'){renderTagSearchView();return}
    var html='';
    if(currentView==='all')html=renderAllView();
    else if(currentView==='pref')html=renderPrefView();
    else if(currentView==='schedule')html=renderSchedSearchView();
    else if(currentView.indexOf('target_')===0)html=renderTargetView(currentView.substring(7));
    w.innerHTML=html;
    var si=document.getElementById('subSearch');if(si)si.addEventListener('input',function(e){onSubSearch(e.target.value)});
}
function renderAllView(){
    var rb=cfg?'<div class="refresh-bar"><button class="btn-refresh" onclick="refreshGH()">&#x1F504; GitHubから更新</button></div>':'';
    return'<div class="view-header"><div class="view-title">全施設一覧</div><div class="view-count">'+hospitals.length+'件</div></div>'+rb+'<div class="search-wrap"><input type="text" class="search-input" id="subSearch" placeholder="施設名・住所で検索..."></div><div id="subList">'+renderCards(hospitals)+'</div>';
}

/* --- Prefecture view with target cross-filter --- */
function renderPrefView(){
    var html='<div class="view-header"><div class="view-title">都道府県別</div></div>';
    if(targets.length>0){
        html+='<div class="form-card" style="margin-bottom:12px;padding:12px 14px"><label class="fl">ターゲットで絞り込み</label><div class="filter-grid" id="prefTargetFilter">';
        targets.forEach(function(t){html+='<label class="filter-chk"><input type="checkbox" value="'+esc(t)+'" onchange="renderPrefResults()"> '+esc(t)+'</label>'});
        html+='</div></div>';
    }
    html+='<div id="prefResults"></div>';
    setTimeout(renderPrefResults,0);
    return html;
}
function renderPrefResults(){
    var w=document.getElementById('prefResults');if(!w)return;
    var selT=[];document.querySelectorAll('#prefTargetFilter input:checked').forEach(function(c){selT.push(c.value);c.parentElement.classList.add('checked')});
    document.querySelectorAll('#prefTargetFilter input:not(:checked)').forEach(function(c){c.parentElement.classList.remove('checked')});
    var filtered=[];hospitals.forEach(function(h,i){if(selT.length>0){var tl=getTargets(h);if(!selT.some(function(st){return tl.indexOf(st)>=0}))return}filtered.push({h:h,idx:i})});
    var map={};filtered.forEach(function(item){var p=item.h.Prefecture||'（未設定）';if(!map[p])map[p]=[];map[p].push(item)});
    var sorted=Object.keys(map).sort(function(a,b){return map[b].length-map[a].length});
    var html='<div class="view-count" style="margin-bottom:8px">'+sorted.length+'地域 / '+filtered.length+'件</div>';
    sorted.forEach(function(pref){var list=map[pref],isO=openPrefs[pref],sp=esc(pref);
        html+='<div class="pref-group"><div class="pref-header '+(isO?'open':'')+'" onclick="togglePref(this,\''+sp.replace(/'/g,"\\'")+'\')">'+'<span>&#x1F4CD; '+sp+'</span><span><span class="pref-count">'+list.length+'</span><span class="pref-arrow">&#x25BC;</span></span></div>'+'<div class="pref-items '+(isO?'open':'')+'">';
        list.forEach(function(item){html+=cardInGroup(item.h,item.idx)});html+='</div></div>'});
    w.innerHTML=html;
}

/* --- Target view with prefecture cross-filter --- */
function renderTargetView(tName){
    var all=[];hospitals.forEach(function(h,i){if(getTargets(h).indexOf(tName)>=0)all.push({h:h,idx:i})});
    var prefSet={};all.forEach(function(item){if(item.h.Prefecture)prefSet[item.h.Prefecture]=true});var prefs=Object.keys(prefSet).sort();
    var html='<div class="view-header"><div class="view-title">'+esc(tName)+'</div><div class="view-count">'+all.length+'件</div></div>';
    if(prefs.length>1){
        html+='<div class="form-card" style="margin-bottom:12px;padding:12px 14px"><label class="fl">都道府県で絞り込み</label><div class="filter-grid" id="targetPrefFilter">';
        prefs.forEach(function(p){html+='<label class="filter-chk"><input type="checkbox" value="'+esc(p)+'" onchange="renderTargetResults(\''+esc(tName).replace(/'/g,"\\'")+'\')"> '+esc(p)+'</label>'});
        html+='</div></div>';
    }
    html+='<div class="search-wrap"><input type="text" class="search-input" id="subSearch" placeholder="施設名で検索..."></div>';
    html+='<div id="subList">';
    if(!all.length)html+='<div class="empty"><div class="empty-icon">&#x1F4ED;</div><div class="empty-text">該当する施設がありません</div></div>';
    else all.forEach(function(item){html+=cardStandalone(item.h,item.idx)});
    html+='</div>';
    return html;
}
function renderTargetResults(tName){
    var selP=[];document.querySelectorAll('#targetPrefFilter input:checked').forEach(function(c){selP.push(c.value);c.parentElement.classList.add('checked')});
    document.querySelectorAll('#targetPrefFilter input:not(:checked)').forEach(function(c){c.parentElement.classList.remove('checked')});
    var filtered=[];hospitals.forEach(function(h,i){if(getTargets(h).indexOf(tName)<0)return;if(selP.length>0&&selP.indexOf(h.Prefecture)<0)return;filtered.push({h:h,idx:i})});
    var w=document.getElementById('subList');if(!w)return;
    if(!filtered.length){w.innerHTML='<div class="empty"><div class="empty-icon">&#x1F4ED;</div><div class="empty-text">該当なし</div></div>';return}
    var html='';filtered.forEach(function(item){html+=cardStandalone(item.h,item.idx)});w.innerHTML=html;
}

/* --- Schedule search with AM/PM filter --- */
function renderSchedSearchView(){
    var hospWS={};schedules.forEach(function(s){if(s.StaffName)hospWS[s.HospitalName]=true});
    var prefSet={};hospitals.forEach(function(h){if(hospWS[h.Name]&&h.Prefecture)prefSet[h.Prefecture]=true});
    var prefs=Object.keys(prefSet).sort(),days=['月','火','水','木','金','土','日'];
    var html='<div class="view-header"><div class="view-title">外来予定検索</div></div><div class="form-card">';
    html+='<label class="fl">都道府県</label><div class="filter-grid" id="schedPrefFilter">';
    prefs.forEach(function(p){html+='<label class="filter-chk"><input type="checkbox" value="'+esc(p)+'" onchange="onSchedFilterChange()"> '+esc(p)+'</label>'});
    if(!prefs.length)html+='<span class="help">外来スケジュールが登録された施設がありません</span>';
    html+='</div><label class="fl">市町村</label><div class="filter-grid" id="schedCityFilter"></div>';
    html+='<label class="fl">曜日</label><div class="filter-grid" id="schedDayFilter">';
    days.forEach(function(d){html+='<label class="filter-chk"><input type="checkbox" value="'+d+'" onchange="onSchedFilterChange()"> '+d+'曜</label>'});
    html+='</div>';
    html+='<label class="fl">時間帯</label><div class="filter-grid" id="schedPeriodFilter">';
    html+='<label class="filter-chk"><input type="checkbox" value="AM" onchange="onSchedFilterChange()"> 午前</label>';
    html+='<label class="filter-chk"><input type="checkbox" value="PM" onchange="onSchedFilterChange()"> 午後</label>';
    html+='</div></div><div id="schedResults"></div>';
    return html;
}
function onSchedFilterChange(){
    var selP=[];document.querySelectorAll('#schedPrefFilter input:checked').forEach(function(c){selP.push(c.value)});
    var hospWS={};schedules.forEach(function(s){if(s.StaffName)hospWS[s.HospitalName]=true});
    var cityMap={};hospitals.forEach(function(h){if(hospWS[h.Name]&&selP.indexOf(h.Prefecture)>=0&&h.City)cityMap[h.City]=true});
    var cW=document.getElementById('schedCityFilter'),cities=Object.keys(cityMap).sort();
    if(!selP.length)cW.innerHTML='<span class="help">都道府県を選択してください</span>';
    else if(!cities.length)cW.innerHTML='<span class="help">該当なし</span>';
    else{var ch='';cities.forEach(function(c){ch+='<label class="filter-chk"><input type="checkbox" value="'+esc(c)+'" onchange="onSchedFilterChange()"> '+esc(c)+'</label>'});cW.innerHTML=ch}
    document.querySelectorAll('.filter-chk input').forEach(function(inp){if(inp.checked)inp.parentElement.classList.add('checked');else inp.parentElement.classList.remove('checked')});
    renderSchedResults();
}
function renderSchedResults(){
    var w=document.getElementById('schedResults');if(!w)return;
    var selP=[],selC=[],selD=[],selPd=[];
    document.querySelectorAll('#schedPrefFilter input:checked').forEach(function(c){selP.push(c.value)});
    document.querySelectorAll('#schedCityFilter input:checked').forEach(function(c){selC.push(c.value)});
    document.querySelectorAll('#schedDayFilter input:checked').forEach(function(c){selD.push(c.value)});
    document.querySelectorAll('#schedPeriodFilter input:checked').forEach(function(c){selPd.push(c.value)});
    if(!selP.length&&!selD.length&&!selPd.length){w.innerHTML='<div class="empty"><div class="empty-icon">&#x1F50D;</div><div class="empty-text">条件を選択してください</div></div>';return}
    var results=[],hMap={};hospitals.forEach(function(h){hMap[h.Name]=h});
    schedules.forEach(function(s){if(!s.StaffName)return;var h=hMap[s.HospitalName];if(!h)return;
        if(selP.length&&selP.indexOf(h.Prefecture)<0)return;if(selC.length&&selC.indexOf(h.City)<0)return;
        if(selD.length&&selD.indexOf(s.DayOfWeek)<0)return;if(selPd.length&&selPd.indexOf(s.Period)<0)return;
        results.push({hospital:s.HospitalName,pref:h.Prefecture,city:h.City,day:s.DayOfWeek,period:s.Period,staff:s.StaffName})});
    if(!results.length){w.innerHTML='<div class="empty"><div class="empty-icon">&#x1F4ED;</div><div class="empty-text">該当する外来予定がありません</div></div>';return}
    var grouped={};results.forEach(function(r){if(!grouped[r.hospital])grouped[r.hospital]={info:r,entries:[]};grouped[r.hospital].entries.push(r)});
    var html='<div class="view-header"><div class="view-title">検索結果</div><div class="view-count">'+Object.keys(grouped).length+'施設</div></div>';
    Object.keys(grouped).forEach(function(hn){var g=grouped[hn];html+='<div class="form-card" style="margin-bottom:10px"><div style="font-weight:800;font-size:15px;margin-bottom:4px">&#x1F3E5; '+esc(hn)+'</div><div style="font-size:12px;color:var(--text-sub);margin-bottom:8px">&#x1F4CD; '+esc(g.info.pref)+' '+esc(g.info.city)+'</div>';
        g.entries.forEach(function(e){html+='<div class="staff-mini-card"><span class="s-name">'+esc(e.staff)+'</span><span class="s-type">'+esc(e.day)+'曜 '+(e.period==='AM'?'午前':'午後')+'</span></div>'});html+='</div>'});
    w.innerHTML=html;
}

/* === CARD RENDERERS === */
function renderCards(list){if(!list.length)return'<div class="empty"><div class="empty-icon">&#x1F4ED;</div><div class="empty-text">施設が登録されていません</div></div>';var h='';list.forEach(function(ho,i){h+=cardStandalone(ho,i)});return h}
function cardStandalone(h,idx){return'<div class="h-card-standalone" onclick="showDetail('+idx+')"><div class="h-info"><div class="h-name">'+esc(h.Name||'')+'</div><div class="h-sub">'+esc(h.Prefecture||'')+' '+esc(h.City||'')+(h.Phone?' ・ '+esc(h.Phone):'')+'</div></div>'+badgesHTML(h)+'<span class="h-chevron">&#x203A;</span></div>'}
function cardInGroup(h,idx){return'<div class="h-card" onclick="showDetail('+idx+')"><div class="h-info"><div class="h-name">'+esc(h.Name||'')+'</div><div class="h-sub">'+esc(h.City||'')+(h.Phone?' ・ '+esc(h.Phone):'')+'</div></div>'+badgesHTML(h)+'<span class="h-chevron">&#x203A;</span></div>'}
function badgesHTML(h){return''}
function togglePref(el,p){el.classList.toggle('open');var it=el.nextElementSibling;it.classList.toggle('open');openPrefs[p]=it.classList.contains('open')}
function onSubSearch(kw){
    var le=document.getElementById('subList');if(!le)return;
    var src=[];if(currentView==='all')hospitals.forEach(function(h,i){src.push({h:h,idx:i})});
    else if(currentView.indexOf('target_')===0){var tn=currentView.substring(7);hospitals.forEach(function(h,i){if(getTargets(h).indexOf(tn)>=0)src.push({h:h,idx:i})})}
    if(!kw){var html='';src.forEach(function(item){html+=cardStandalone(item.h,item.idx)});le.innerHTML=html||'<div class="empty"><div class="empty-text">該当なし</div></div>';return}
    var f=src.filter(function(item){var h=item.h;return(h.Name||'').indexOf(kw)>=0||(h.Prefecture||'').indexOf(kw)>=0||(h.City||'').indexOf(kw)>=0||(h.Address||'').indexOf(kw)>=0});
    if(f.length){var fh='';f.forEach(function(item){fh+=cardStandalone(item.h,item.idx)});le.innerHTML=fh}else le.innerHTML='<div class="empty"><div class="empty-icon">&#x1F50D;</div><div class="empty-text">該当する施設がありません</div></div>';
}

/* === HOSPITAL DETAIL === */
function showDetail(idx){
    currentIdx=idx;var h=hospitals[idx];if(!h)return;
    var rows=[['&#x1F4CD; 所在地',(h.Prefecture||'')+' '+(h.City||'')],['住所',h.Address],['&#x1F4DE; 電話',h.Phone],['病床数',h.BedCount],['ICU病床数',h.ICUBeds],['透析室病床数',h.DialysisBeds],['透析患者数',h.DialysisPatients],['透析装置更新年度',h.DialysisRenewalYear],['その他',h.Other],['&#x1F4DD; メモ',h.Memo]];
    var tl=getTargets(h),badges='';tl.forEach(function(t){badges+='<span class="h-badge h-badge-target" style="font-size:12px;padding:4px 12px">&#x1F3AF; '+esc(t)+'</span>'});
    var html='<div style="font-size:20px;font-weight:800;margin-bottom:6px">'+esc(h.Name||'')+'</div>';
    if(badges)html+='<div class="detail-badges">'+badges+'</div>';
    rows.forEach(function(r){if(!r[1])return;if(r[0]==='&#x1F4DE; 電話')html+='<div class="detail-row"><div class="detail-lbl">'+r[0]+'</div><div class="detail-val"><a href="tel:'+esc(r[1])+'">'+esc(r[1])+'</a></div></div>';else html+='<div class="detail-row"><div class="detail-lbl">'+r[0]+'</div><div class="detail-val">'+esc(r[1])+'</div></div>'});
    var ls=staffMembers.filter(function(s){return s.HospitalName===h.Name});
    if(ls.length){html+='<div class="staff-section"><h3>&#x1F464; 所属医療従事者（'+ls.length+'名）</h3>';ls.forEach(function(s){html+='<div class="staff-mini-card"><span class="s-name">'+esc(s.Name)+'</span><span class="s-type">'+esc(s.JobType)+'</span></div>'});html+='<div style="margin-top:12px"><button class="btn btn-outline btn-sm" onclick="openSchedEditor('+idx+')">&#x1F4C5; 外来スケジュール</button></div></div>'}
    document.getElementById('detailBody').innerHTML=html;document.getElementById('detailModal').classList.add('show');
}

/* === HOSPITAL EDIT === */
function openEditFromDetail(){closeModal('detailModal');openEdit(currentIdx)}
function openEdit(idx){
    currentIdx=idx;var h=hospitals[idx];if(!h)return;
    var fields=[['施設名 *','ed-name','text',h.Name],['都道府県 *','ed-pref','text',h.Prefecture],['市町村 *','ed-city','text',h.City],['住所','ed-addr','text',h.Address],['代表電話番号','ed-phone','tel',h.Phone],['病床数','ed-bedcount','number',h.BedCount],['ICU病床数','ed-icubeds','number',h.ICUBeds],['透析室病床数','ed-dialysisbeds','number',h.DialysisBeds],['透析患者数','ed-dialysispatients','number',h.DialysisPatients],['透析装置更新年度','ed-renewalyear','text',h.DialysisRenewalYear],['その他','ed-other','text',h.Other]];
    var html='';fields.forEach(function(f){html+='<div class="fg"><label class="fl">'+f[0]+'</label><input type="'+f[2]+'" class="fi" id="'+f[1]+'" value="'+esc(f[3]||'')+'"></div>'});
    html+='<div class="fg"><label class="fl">メモ</label><textarea class="fi" id="ed-memo">'+esc(h.Memo||'')+'</textarea></div>';
    var ct=getTargets(h);html+='<div class="fg"><label class="fl">ターゲット分類</label>';
    if(targets.length)targets.forEach(function(t){html+='<div class="chk-row"><input type="checkbox" class="ed-target-chk" value="'+esc(t)+'" '+(ct.indexOf(t)>=0?'checked':'')+'><label>'+esc(t)+'</label></div>'});
    else html+='<div class="help">設定タブでターゲットを追加してください</div>';
    html+='</div><button class="btn btn-success" onclick="saveEdit()">&#x1F4BE; 保存する</button><button class="btn btn-danger" onclick="deleteFromEdit()">&#x1F5D1; 削除</button>';
    document.getElementById('editFormWrap').innerHTML=html;document.getElementById('editModal').classList.add('show');
}
function saveEdit(){
    if(currentIdx<0)return;var st=[];document.querySelectorAll('.ed-target-chk:checked').forEach(function(c){st.push(c.value)});
    hospitals[currentIdx]={Name:document.getElementById('ed-name').value,Prefecture:document.getElementById('ed-pref').value,City:document.getElementById('ed-city').value,Address:document.getElementById('ed-addr').value,Phone:document.getElementById('ed-phone').value,BedCount:document.getElementById('ed-bedcount').value,ICUBeds:document.getElementById('ed-icubeds').value,DialysisBeds:document.getElementById('ed-dialysisbeds').value,DialysisPatients:document.getElementById('ed-dialysispatients').value,DialysisRenewalYear:document.getElementById('ed-renewalyear').value,Other:document.getElementById('ed-other').value,Memo:document.getElementById('ed-memo').value,Targets:st.join(';')};
    closeModal('editModal');if(cfg)saveH();renderDash();renderSubView();toast('施設情報を更新しました');
}
function deleteFromDetail(){if(!confirm('この施設を削除してもよろしいですか？'))return;hospitals.splice(currentIdx,1);closeModal('detailModal');if(cfg)saveH();renderDash();renderSubView();toast('施設を削除しました')}
function deleteFromEdit(){if(!confirm('この施設を削除してもよろしいですか？'))return;hospitals.splice(currentIdx,1);closeModal('editModal');if(cfg)saveH();renderDash();renderSubView();toast('施設を削除しました')}

/* === ADD HOSPITAL === */
function addHospital(){
    var n=document.getElementById('inp-name').value.trim(),p=document.getElementById('inp-pref').value.trim(),c=document.getElementById('inp-city').value.trim();
    if(!n||!p||!c){toast('施設名・都道府県・市町村は必須です','error');return}
    var st=[];document.querySelectorAll('#inp-targets-wrap input:checked').forEach(function(c){st.push(c.value)});
    hospitals.push({Name:n,Prefecture:p,City:c,Address:document.getElementById('inp-addr').value,Phone:document.getElementById('inp-phone').value,BedCount:document.getElementById('inp-bedcount').value,ICUBeds:document.getElementById('inp-icubeds').value,DialysisBeds:document.getElementById('inp-dialysisbeds').value,DialysisPatients:document.getElementById('inp-dialysispatients').value,DialysisRenewalYear:document.getElementById('inp-renewalyear').value,Other:document.getElementById('inp-other').value,Memo:document.getElementById('inp-memo').value,Targets:st.join(';')});
    if(cfg)saveH();['inp-name','inp-pref','inp-city','inp-addr','inp-phone','inp-bedcount','inp-icubeds','inp-dialysisbeds','inp-dialysispatients','inp-renewalyear','inp-other','inp-memo'].forEach(function(id){document.getElementById(id).value=''});
    document.querySelectorAll('#inp-targets-wrap input').forEach(function(c){c.checked=false});renderDash();renderSubView();toast('施設を登録しました');
}

/* === REFRESH ADD SELECTS === */
function refreshAddSelects(){
    var hS=document.getElementById('inp-shospital');if(hS){var v=hS.value;hS.innerHTML='<option value="">-- 選択 --</option>';hospitals.forEach(function(h){hS.innerHTML+='<option value="'+esc(h.Name)+'">'+esc(h.Name)+'</option>'});if(v)hS.value=v}
    var jS=document.getElementById('inp-sjobtype');if(jS){var jv=jS.value;jS.innerHTML='<option value="">-- 選択 --</option>';jobTypes.forEach(function(j){jS.innerHTML+='<option value="'+esc(j)+'">'+esc(j)+'</option>'});if(jv)jS.value=jv}
    var tW=document.getElementById('inp-targets-wrap');if(tW){if(targets.length){var th='';targets.forEach(function(t){th+='<div class="chk-row"><input type="checkbox" value="'+esc(t)+'"><label>'+esc(t)+'</label></div>'});tW.innerHTML=th}else tW.innerHTML='<span class="help">設定タブでターゲットを追加してください</span>'}
    // appointment add selects
    var aH=document.getElementById('inp-ahospital');if(aH){var av=aH.value;aH.innerHTML='<option value="">-- 選択 --</option>';hospitals.forEach(function(h){aH.innerHTML+='<option value="'+esc(h.Name)+'">'+esc(h.Name)+'</option>'});if(av)aH.value=av}
}
function onInpAHospChange(){var hn=document.getElementById('inp-ahospital').value,sel=document.getElementById('inp-astaff');sel.innerHTML='<option value="">-- 選択 --</option>';if(!hn)return;staffMembers.filter(function(s){return s.HospitalName===hn}).forEach(function(s){sel.innerHTML+='<option value="'+esc(s.Name)+'">'+esc(s.Name)+' ('+esc(s.JobType)+')</option>'})}

/* === STAFF LIST === */
function renderStaffList(kw){
    var w=document.getElementById('staffList'),ce=document.getElementById('staffCount');if(!w)return;
    var f=staffMembers;if(kw)f=staffMembers.filter(function(s){return(s.Name||'').indexOf(kw)>=0||(s.HospitalName||'').indexOf(kw)>=0||(s.JobType||'').indexOf(kw)>=0});
    ce.textContent=f.length+'件';
    if(!f.length){w.innerHTML='<div class="empty"><div class="empty-icon">&#x1F464;</div><div class="empty-text">'+(kw?'該当なし':'医療従事者が登録されていません')+'</div></div>';return}
    var html='';f.forEach(function(s){var ri=staffMembers.indexOf(s);html+='<div class="h-card-standalone" onclick="showStaffDetail('+ri+')"><div class="h-info"><div class="h-name">'+esc(s.Name||'')+'</div><div class="h-sub">'+esc(s.HospitalName||'')+' ・ '+esc(s.JobType||'')+'</div></div><span class="h-chevron">&#x203A;</span></div>'});w.innerHTML=html;
}
function showStaffDetail(idx){
    currentStaffIdx=idx;var s=staffMembers[idx];if(!s)return;
    var rows=[['&#x1F3E5; 所属施設',s.HospitalName],['&#x1F4BC; 職種',s.JobType],['&#x1F4DE; 電話',s.Phone],['&#x1F4E7; メール',s.Email],['&#x1F4DD; メモ',s.Memo]];
    var html='<div style="font-size:20px;font-weight:800;margin-bottom:10px">'+esc(s.Name||'')+'</div>';
    rows.forEach(function(r){if(!r[1])return;if(r[0]==='&#x1F4DE; 電話')html+='<div class="detail-row"><div class="detail-lbl">'+r[0]+'</div><div class="detail-val"><a href="tel:'+esc(r[1])+'">'+esc(r[1])+'</a></div></div>';else if(r[0]==='&#x1F4E7; メール')html+='<div class="detail-row"><div class="detail-lbl">'+r[0]+'</div><div class="detail-val"><a href="mailto:'+esc(r[1])+'">'+esc(r[1])+'</a></div></div>';else html+='<div class="detail-row"><div class="detail-lbl">'+r[0]+'</div><div class="detail-val">'+esc(r[1])+'</div></div>'});
    document.getElementById('staffDetailBody').innerHTML=html;document.getElementById('staffDetailModal').classList.add('show');
}
function openStaffEditFromDetail(){closeModal('staffDetailModal');openStaffEdit(currentStaffIdx)}
function openStaffEdit(idx){
    currentStaffIdx=idx;var s=staffMembers[idx];if(!s)return;
    var html='<div class="fg"><label class="fl">氏名 *</label><input type="text" class="fi" id="sed-name" value="'+esc(s.Name||'')+'"></div>';
    html+='<div class="fg"><label class="fl">所属施設 *</label><select class="fi" id="sed-hospital"><option value="">-- 選択 --</option>';hospitals.forEach(function(h){html+='<option value="'+esc(h.Name)+'"'+(h.Name===s.HospitalName?' selected':'')+'>'+esc(h.Name)+'</option>'});html+='</select></div>';
    html+='<div class="fg"><label class="fl">職種 *</label><select class="fi" id="sed-jobtype"><option value="">-- 選択 --</option>';jobTypes.forEach(function(j){html+='<option value="'+esc(j)+'"'+(j===s.JobType?' selected':'')+'>'+esc(j)+'</option>'});html+='</select></div>';
    html+='<div class="fg"><label class="fl">電話番号</label><input type="tel" class="fi" id="sed-phone" value="'+esc(s.Phone||'')+'"></div>';
    html+='<div class="fg"><label class="fl">メールアドレス</label><input type="email" class="fi" id="sed-email" value="'+esc(s.Email||'')+'"></div>';
    html+='<div class="fg"><label class="fl">メモ</label><textarea class="fi" id="sed-memo">'+esc(s.Memo||'')+'</textarea></div>';
    html+='<button class="btn btn-success" onclick="saveStaffEdit()">&#x1F4BE; 保存</button><button class="btn btn-danger" onclick="deleteStaffFromEdit()">&#x1F5D1; 削除</button>';
    document.getElementById('staffEditFormWrap').innerHTML=html;document.getElementById('staffEditModal').classList.add('show');
}
function saveStaffEdit(){
    if(currentStaffIdx<0)return;var n=document.getElementById('sed-name').value.trim(),h=document.getElementById('sed-hospital').value,j=document.getElementById('sed-jobtype').value;
    if(!n||!h||!j){toast('氏名・所属施設・職種は必須です','error');return}
    var on=staffMembers[currentStaffIdx].Name,oh=staffMembers[currentStaffIdx].HospitalName;
    staffMembers[currentStaffIdx]={ID:staffMembers[currentStaffIdx].ID,Name:n,HospitalName:h,JobType:j,Phone:document.getElementById('sed-phone').value,Email:document.getElementById('sed-email').value,Memo:document.getElementById('sed-memo').value};
    if(on!==n){schedules.forEach(function(sc){if(sc.StaffName===on&&sc.HospitalName===oh)sc.StaffName=n});if(cfg)saveSch()}
    closeModal('staffEditModal');if(cfg)saveS();renderStaffList();toast('医療従事者情報を更新しました');
}
function deleteStaffFromDetail(){if(!confirm('削除しますか？'))return;staffMembers.splice(currentStaffIdx,1);closeModal('staffDetailModal');if(cfg)saveS();renderStaffList();toast('削除しました')}
function deleteStaffFromEdit(){if(!confirm('削除しますか？'))return;staffMembers.splice(currentStaffIdx,1);closeModal('staffEditModal');if(cfg)saveS();renderStaffList();toast('削除しました')}
function addStaff(){
    var n=document.getElementById('inp-sname').value.trim(),h=document.getElementById('inp-shospital').value,j=document.getElementById('inp-sjobtype').value;
    if(!n||!h||!j){toast('氏名・所属施設・職種は必須です','error');return}
    staffMembers.push({ID:genId(),Name:n,HospitalName:h,JobType:j,Phone:document.getElementById('inp-sphone').value,Email:document.getElementById('inp-semail').value,Memo:document.getElementById('inp-smemo').value});
    if(cfg)saveS();['inp-sname','inp-sphone','inp-semail','inp-smemo'].forEach(function(id){document.getElementById(id).value=''});document.getElementById('inp-shospital').value='';document.getElementById('inp-sjobtype').value='';renderStaffList();toast('医療従事者を登録しました');
}

/* === SCHEDULE EDITOR === */
function openSchedEditor(hIdx){
    closeModal('detailModal');var h=hospitals[hIdx];if(!h)return;
    var ls=staffMembers.filter(function(s){return s.HospitalName===h.Name}),days=['月','火','水','木','金','土','日'],periods=['AM','PM'],slots=['1','2','3'];
    var sm={};schedules.forEach(function(s){if(s.HospitalName===h.Name)sm[s.DayOfWeek+'_'+s.Period+'_'+s.Slot]=s.StaffName});
    var html='<div style="font-size:16px;font-weight:800;margin-bottom:12px">&#x1F3E5; '+esc(h.Name)+'</div><div style="overflow-x:auto"><table class="sched-table"><tr><th style="width:80px"></th>';
    days.forEach(function(d){html+='<th class="sched-day-header">'+d+'曜</th>'});html+='</tr>';
    periods.forEach(function(p){for(var si=0;si<3;si++){html+='<tr>';if(si===0)html+='<th rowspan="3" style="background:'+(p==='AM'?'#e8f4fd':'#fef3e6')+'">'+(p==='AM'?'午前':'午後')+'</th>';
        days.forEach(function(d){var k=d+'_'+p+'_'+slots[si],cv=sm[k]||'';html+='<td><select class="sched-sel" data-day="'+d+'" data-period="'+p+'" data-slot="'+slots[si]+'"><option value="">-</option>';ls.forEach(function(s){html+='<option value="'+esc(s.Name)+'"'+(s.Name===cv?' selected':'')+'>'+esc(s.Name)+'</option>'});html+='</select></td>'});html+='</tr>'}});
    html+='</table></div><button class="btn btn-success" style="margin-top:14px" onclick="saveSched(\''+esc(h.Name).replace(/'/g,"\\'")+'\')">&#x1F4BE; スケジュールを保存</button>';
    document.getElementById('scheduleBody').innerHTML=html;document.getElementById('scheduleModal').classList.add('show');
}
function saveSched(hn){schedules=schedules.filter(function(s){return s.HospitalName!==hn});document.querySelectorAll('.sched-sel').forEach(function(sel){if(sel.value)schedules.push({HospitalName:hn,DayOfWeek:sel.getAttribute('data-day'),Period:sel.getAttribute('data-period'),Slot:sel.getAttribute('data-slot'),StaffName:sel.value})});if(cfg)saveSch();closeModal('scheduleModal');renderDash();toast('外来スケジュールを保存しました')}

/* === CALENDAR === */
function renderCalendar(){
    var y=calendarDate.getFullYear(),m=calendarDate.getMonth(),mn=['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'];
    var html='<div class="form-card" style="padding:14px"><div class="cal-nav"><button class="btn btn-outline btn-sm" style="margin:0" onclick="calNav(-1)">&#x25C0; 前月</button><span>'+y+'年'+mn[m]+'</span><button class="btn btn-outline btn-sm" style="margin:0" onclick="calNav(1)">次月 &#x25B6;</button></div>';
    var dayN=['日','月','火','水','木','金','土'];html+='<table class="cal-grid"><tr>';
    dayN.forEach(function(d,i){var col=i===0?'var(--danger)':i===6?'var(--primary)':'var(--text)';html+='<th style="color:'+col+'">'+d+'</th>'});html+='</tr>';
    var fd=new Date(y,m,1).getDay(),dim=new Date(y,m+1,0).getDate();
    var today=new Date(),todayStr=today.getFullYear()+'-'+pad2(today.getMonth()+1)+'-'+pad2(today.getDate());
    var ym=y+'-'+pad2(m+1);var dc={},dcf={};appointments.forEach(function(a){if(a.Date&&a.Date.substring(0,7)===ym){var d=parseInt(a.Date.substring(8,10));if(!dc[d])dc[d]=0;dc[d]++;if(a.Status==='confirmed')dcf[d]=true}});
    var dn=1;for(var row=0;row<6;row++){if(dn>dim)break;html+='<tr>';for(var col=0;col<7;col++){if(row===0&&col<fd||dn>dim){html+='<td></td>'}else{var ds=y+'-'+pad2(m+1)+'-'+pad2(dn),isT=ds===todayStr,isS=ds===calendarSelectedDate,cnt=dc[dn]||0;
        var cls='';if(isS)cls=' selected';else if(isT)cls=' today';
        html+='<td class="'+cls+'" onclick="selCalDate(\''+ds+'\')"><div style="font-size:14px">'+dn+'</div>';
        if(cnt>0){var dots='';if(dcf[dn])dots+='<span class="cal-dot conf"></span>';else dots+='<span class="cal-dot cand"></span>';if(cnt>1)dots+='<span style="font-size:8px;color:var(--text-sub)">'+cnt+'</span>';html+='<div>'+dots+'</div>'}
        html+='</td>';dn++}}html+='</tr>'}
    html+='</table></div><div id="calDayDetail">';
    if(calendarSelectedDate)html+=renderDayDetail(calendarSelectedDate);
    html+='</div>';document.getElementById('calendarView').innerHTML=html;
}
function calNav(d){calendarDate.setMonth(calendarDate.getMonth()+d);renderCalendar()}
function selCalDate(ds){calendarSelectedDate=ds;renderCalendar()}
function renderDayDetail(ds){
    var da=appointments.filter(function(a){return a.Date===ds}).sort(function(a,b){return(a.Time||'').localeCompare(b.Time||'')});
    var parts=ds.split('-'),disp=parseInt(parts[1])+'月'+parseInt(parts[2])+'日';
    var html='<div class="view-header"><div class="view-title">'+disp+' の予定</div><button class="btn btn-success btn-sm" style="margin:0" onclick="openAddAppt(\''+ds+'\')">＋ 予定追加</button></div>';
    if(!da.length){html+='<div class="empty" style="padding:20px"><div class="empty-text">予定はありません</div></div>';return html}
    da.forEach(function(a){var isC=a.Status==='confirmed';
        html+='<div class="appt-card'+(isC?' confirmed':'')+'"><div class="appt-top"><div><span class="appt-title">'+esc(a.Title)+'</span><span class="status-badge '+(isC?'status-conf':'status-cand')+'">'+(isC?'確定':'候補')+'</span></div><span class="appt-time">'+esc(a.Time||'')+'</span></div>';
        html+='<div class="appt-meta">&#x1F3E5; '+esc(a.HospitalName||'')+' ・ &#x1F464; '+esc(a.StaffName||'')+'</div>';
        if(a.Notes)html+='<div class="appt-meta">&#x1F4DD; '+esc(a.Notes)+'</div>';
        html+='<div class="appt-actions">';
        if(!isC)html+='<button class="btn btn-success btn-sm" style="margin:0" onclick="confirmAppt(\''+esc(a.ID)+'\')">&#x2714; 確定</button>';
        html+='<button class="btn btn-outline btn-sm" style="margin:0" onclick="editAppt(\''+esc(a.ID)+'\')">&#x270F; 編集</button>';
        html+='<button class="btn btn-danger btn-sm" style="margin:0" onclick="deleteAppt(\''+esc(a.ID)+'\')">&#x1F5D1; 削除</button>';
        html+='</div></div>'});
    return html;
}

/* === APPOINTMENT CRUD === */
function openAddAppt(ds){
    var html='<div class="fg"><label class="fl">タイトル *</label><input type="text" class="fi" id="appt-title"></div>';
    html+='<div class="fg"><label class="fl">施設</label><select class="fi" id="appt-hospital" onchange="onApptHospChange()"><option value="">-- 選択 --</option>';hospitals.forEach(function(h){html+='<option value="'+esc(h.Name)+'">'+esc(h.Name)+'</option>'});html+='</select></div>';
    html+='<div class="fg"><label class="fl">担当者</label><select class="fi" id="appt-staff"><option value="">-- 施設を選択 --</option></select></div>';
    html+='<div class="fg"><label class="fl">日付 *</label><input type="date" class="fi" id="appt-date" value="'+(ds||'')+'"></div>';
    html+='<div class="fg"><label class="fl">時間</label><input type="time" class="fi" id="appt-time"></div>';
    html+='<div class="fg"><label class="fl">ステータス</label><select class="fi" id="appt-status"><option value="candidate">候補</option><option value="confirmed">確定</option></select></div>';
    html+='<div class="fg"><label class="fl">メモ</label><textarea class="fi" id="appt-notes"></textarea></div>';
    html+='<button class="btn btn-success" onclick="saveNewAppt()">&#x2705; 登録する</button>';
    document.getElementById('apptModalTitle').textContent='予定の追加';document.getElementById('apptFormWrap').innerHTML=html;document.getElementById('appointmentModal').classList.add('show');
}
function onApptHospChange(){var hn=document.getElementById('appt-hospital').value,sel=document.getElementById('appt-staff');sel.innerHTML='<option value="">-- 選択 --</option>';if(!hn)return;staffMembers.filter(function(s){return s.HospitalName===hn}).forEach(function(s){sel.innerHTML+='<option value="'+esc(s.Name)+'">'+esc(s.Name)+' ('+esc(s.JobType)+')</option>'})}
function saveNewAppt(){var t=document.getElementById('appt-title').value.trim(),d=document.getElementById('appt-date').value;if(!t||!d){toast('タイトルと日付は必須です','error');return}appointments.push({ID:genId(),Title:t,HospitalName:document.getElementById('appt-hospital').value,StaffName:document.getElementById('appt-staff').value,Date:d,Time:document.getElementById('appt-time').value,Status:document.getElementById('appt-status').value,Notes:document.getElementById('appt-notes').value});closeModal('appointmentModal');if(cfg)saveA();renderCalendar();toast('予定を登録しました')}
function editAppt(id){
    editingApptId=id;var a=appointments.find(function(x){return x.ID===id});if(!a)return;
    var html='<div class="fg"><label class="fl">タイトル *</label><input type="text" class="fi" id="appt-title" value="'+esc(a.Title||'')+'"></div>';
    html+='<div class="fg"><label class="fl">施設</label><select class="fi" id="appt-hospital" onchange="onApptHospChange()"><option value="">-- 選択 --</option>';hospitals.forEach(function(h){html+='<option value="'+esc(h.Name)+'"'+(h.Name===a.HospitalName?' selected':'')+'>'+esc(h.Name)+'</option>'});html+='</select></div>';
    html+='<div class="fg"><label class="fl">担当者</label><select class="fi" id="appt-staff"><option value="">-- 選択 --</option>';staffMembers.filter(function(s){return s.HospitalName===a.HospitalName}).forEach(function(s){html+='<option value="'+esc(s.Name)+'"'+(s.Name===a.StaffName?' selected':'')+'>'+esc(s.Name)+' ('+esc(s.JobType)+')</option>'});html+='</select></div>';
    html+='<div class="fg"><label class="fl">日付 *</label><input type="date" class="fi" id="appt-date" value="'+esc(a.Date||'')+'"></div>';
    html+='<div class="fg"><label class="fl">時間</label><input type="time" class="fi" id="appt-time" value="'+esc(a.Time||'')+'"></div>';
    html+='<div class="fg"><label class="fl">ステータス</label><select class="fi" id="appt-status"><option value="candidate"'+(a.Status==='candidate'?' selected':'')+'>候補</option><option value="confirmed"'+(a.Status==='confirmed'?' selected':'')+'>確定</option></select></div>';
    html+='<div class="fg"><label class="fl">メモ</label><textarea class="fi" id="appt-notes">'+esc(a.Notes||'')+'</textarea></div>';
    html+='<button class="btn btn-success" onclick="saveEditAppt()">&#x1F4BE; 保存する</button>';
    document.getElementById('apptModalTitle').textContent='予定の編集';document.getElementById('apptFormWrap').innerHTML=html;document.getElementById('appointmentModal').classList.add('show');
}
function saveEditAppt(){var t=document.getElementById('appt-title').value.trim(),d=document.getElementById('appt-date').value;if(!t||!d){toast('タイトルと日付は必須です','error');return}var idx=appointments.findIndex(function(a){return a.ID===editingApptId});if(idx<0)return;appointments[idx]={ID:editingApptId,Title:t,HospitalName:document.getElementById('appt-hospital').value,StaffName:document.getElementById('appt-staff').value,Date:d,Time:document.getElementById('appt-time').value,Status:document.getElementById('appt-status').value,Notes:document.getElementById('appt-notes').value};closeModal('appointmentModal');if(cfg)saveA();renderCalendar();toast('予定を更新しました')}
function deleteAppt(id){if(!confirm('この予定を削除しますか？'))return;appointments=appointments.filter(function(a){return a.ID!==id});if(cfg)saveA();renderCalendar();toast('予定を削除しました')}
function confirmAppt(id){var a=appointments.find(function(x){return x.ID===id});if(!a)return;if(!confirm('「'+a.Title+'」を確定しますか？\n同じタイトルの他の候補日は自動削除されます。'))return;a.Status='confirmed';appointments=appointments.filter(function(x){if(x.ID===id)return true;if(x.Title===a.Title&&x.Status==='candidate')return false;return true});if(cfg)saveA();renderCalendar();toast('予定を確定しました')}
function addApptFromTab(){
    var t=document.getElementById('inp-atitle').value.trim(),d=document.getElementById('inp-adate').value;if(!t||!d){toast('タイトルと日付は必須です','error');return}
    appointments.push({ID:genId(),Title:t,HospitalName:document.getElementById('inp-ahospital').value,StaffName:document.getElementById('inp-astaff').value,Date:d,Time:document.getElementById('inp-atime').value,Status:document.getElementById('inp-astatus').value,Notes:document.getElementById('inp-anotes').value});
    if(cfg)saveA();['inp-atitle','inp-atime','inp-anotes'].forEach(function(id){document.getElementById(id).value=''});document.getElementById('inp-adate').value='';document.getElementById('inp-ahospital').value='';document.getElementById('inp-astaff').innerHTML='<option value="">-- 施設を選択 --</option>';document.getElementById('inp-astatus').value='candidate';renderCalendar();toast('予定を登録しました');
}

/* === CSV EXPORT/IMPORT === */
function exportCSV(type){
    var csv,fn;
    if(type==='hospitals'){csv=genHospCSV();fn='hospitals.csv'}
    else if(type==='staff'){csv=genStaffCSV();fn='staff.csv'}
    else{csv=genApptCSV();fn='appointments.csv'}
    var bom='\uFEFF',blob=new Blob([bom+csv],{type:'text/csv;charset=utf-8;'}),url=URL.createObjectURL(blob),a=document.createElement('a');a.href=url;a.download=fn;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
    var el=document.getElementById('exportMailLink'),subj=encodeURIComponent('病院管理データ - '+fn),body=encodeURIComponent(fn+' をダウンロードしました。このメールに添付して送信してください。');
    el.innerHTML='<a href="mailto:?subject='+subj+'&body='+body+'" class="btn btn-outline" style="display:inline-block;width:auto;padding:10px 20px">&#x1F4E7; メールアプリで送信</a>';el.style.display='block';toast(fn+' をダウンロードしました');
}
function importCSV(type){
    var fileId=type==='hospitals'?'importHospFile':type==='staff'?'importStaffFile':'importApptFile';
    var fi=document.getElementById(fileId);if(!fi.files.length){toast('ファイルを選択してください','error');return}
    var reader=new FileReader();reader.onload=function(e){var text=e.target.result;if(text.charCodeAt(0)===0xFEFF)text=text.substring(1);
        if(type==='hospitals'){parseHospitalsCSV(text);if(cfg)saveH();renderDash();renderSubView();toast('施設データをインポートしました（'+hospitals.length+'件）')}
        else if(type==='staff'){parseStaffCSV(text);if(cfg)saveS();renderStaffList();toast('医療従事者をインポートしました（'+staffMembers.length+'件）')}
        else{parseAppointmentsCSV(text);if(cfg)saveA();renderCalendar();toast('アポイントをインポートしました（'+appointments.length+'件）')}};
    reader.readAsText(fi.files[0],'UTF-8');
}

/* === INIT === */
document.addEventListener('DOMContentLoaded',function(){
    loadCfg();document.getElementById('staffSearch').addEventListener('input',function(e){renderStaffList(e.target.value)});
    if(cfg)loadAllFromGitHub();else{if(!jobTypes.length)jobTypes=['ドクター','看護師','臨床工学技士'];renderDash();renderSubView();renderTargetTags();renderJobTypeTags()}
});
</script>
</body>
</html>
