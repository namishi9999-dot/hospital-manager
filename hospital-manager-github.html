<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ç—…é™¢é¡§å®¢ç®¡ç† - GitHubé€£æºç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #1a6fc4;
            --primary-light: #e8f1fa;
            --secondary: #4a5a8a;
            --accent: #e67e22;
            --accent-light: #fef3e6;
            --success: #27ae60;
            --success-light: #eafaf1;
            --danger: #e74c3c;
            --danger-light: #fdecea;
            --bg: #f0f2f5;
            --card: #ffffff;
            --text: #1a1a2e;
            --text-sub: #6b7280;
            --border: #e2e5ea;
            --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --radius: 14px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* â”€â”€ Header â”€â”€ */
        .header {
            background: linear-gradient(135deg, #1a3a5c 0%, #1a6fc4 60%, #2980b9 100%);
            color: #fff;
            padding: 24px 20px 18px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 { font-size: 22px; font-weight: 800; letter-spacing: -0.3px; }
        .header-sub { font-size: 12px; opacity: .75; margin-top: 2px; }
        .sync-badge {
            display: inline-block;
            margin-top: 10px;
            padding: 5px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            background: rgba(255,255,255,.18);
        }
        .sync-badge.synced  { background: rgba(39,174,96,.35); }
        .sync-badge.syncing { background: rgba(241,196,15,.35); }
        .sync-badge.error   { background: rgba(231,76,60,.35); }

        /* â”€â”€ Tab Bar â”€â”€ */
        .tab-bar {
            display: flex;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 82px;
            z-index: 99;
        }
        .tab-btn {
            flex: 1;
            padding: 13px 0;
            text-align: center;
            background: none;
            border: none;
            font-size: 13px;
            font-weight: 700;
            color: var(--text-sub);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all .25s;
        }
        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* â”€â”€ Container â”€â”€ */
        .container {
            max-width: 720px;
            margin: 0 auto;
            padding: 16px 16px 100px;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* â”€â”€ Dashboard Stats Grid â”€â”€ */
        .dash-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 4px;
        }
        .dash-card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 18px 14px;
            text-align: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            border: 2px solid transparent;
            transition: all .2s;
            position: relative;
            overflow: hidden;
        }
        .dash-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
        }
        .dash-card.c-all::before    { background: var(--primary); }
        .dash-card.c-pref::before   { background: var(--secondary); }
        .dash-card.c-out::before    { background: var(--success); }
        .dash-card.c-target::before { background: var(--accent); }

        .dash-card.selected { border-color: var(--primary); background: var(--primary-light); }
        .dash-card.c-pref.selected   { border-color: var(--secondary); background: #eef0f7; }
        .dash-card.c-out.selected    { border-color: var(--success); background: var(--success-light); }
        .dash-card.c-target.selected { border-color: var(--accent); background: var(--accent-light); }

        .dash-card:active { transform: scale(.97); }
        .dash-icon { font-size: 22px; margin-bottom: 4px; }
        .dash-num  { font-size: 30px; font-weight: 800; line-height: 1.1; }
        .dash-label { font-size: 11px; color: var(--text-sub); font-weight: 600; margin-top: 4px; }

        /* â”€â”€ Sub-view header â”€â”€ */
        .view-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0 10px;
        }
        .view-title {
            font-size: 16px;
            font-weight: 800;
            color: var(--text);
        }
        .view-count {
            font-size: 12px;
            color: var(--text-sub);
            font-weight: 600;
            background: var(--bg);
            padding: 4px 10px;
            border-radius: 12px;
        }

        /* â”€â”€ Search â”€â”€ */
        .search-wrap { margin-bottom: 14px; position: relative; }
        .search-wrap::before {
            content: 'ğŸ”';
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
        }
        .search-input {
            width: 100%;
            padding: 12px 16px 12px 42px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 15px;
            background: var(--card);
            transition: border-color .2s;
        }
        .search-input:focus { outline: none; border-color: var(--primary); }

        /* â”€â”€ Prefecture Group â”€â”€ */
        .pref-group {
            background: var(--card);
            border-radius: var(--radius);
            margin-bottom: 10px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        .pref-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            cursor: pointer;
            font-weight: 700;
            font-size: 15px;
            transition: background .15s;
            user-select: none;
        }
        .pref-header:active { background: var(--bg); }
        .pref-count {
            font-size: 12px;
            font-weight: 700;
            color: #fff;
            background: var(--secondary);
            padding: 2px 10px;
            border-radius: 10px;
            min-width: 30px;
            text-align: center;
        }
        .pref-arrow {
            transition: transform .25s;
            font-size: 12px;
            color: var(--text-sub);
            margin-left: 8px;
        }
        .pref-header.open .pref-arrow { transform: rotate(180deg); }
        .pref-items {
            display: none;
            border-top: 1px solid var(--border);
        }
        .pref-items.open { display: block; }

        /* â”€â”€ Hospital Card â”€â”€ */
        .h-card {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            cursor: pointer;
            transition: background .15s;
            border-bottom: 1px solid var(--border);
        }
        .h-card:last-child { border-bottom: none; }
        .h-card:active { background: #f7f8fa; }

        .h-card-standalone {
            background: var(--card);
            border-radius: var(--radius);
            margin-bottom: 8px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            padding: 14px 16px;
            cursor: pointer;
            transition: background .15s, transform .15s;
        }
        .h-card-standalone:active { transform: scale(.99); background: #f7f8fa; }

        .h-info { flex: 1; min-width: 0; }
        .h-name {
            font-size: 15px;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .h-sub {
            font-size: 12px;
            color: var(--text-sub);
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .h-badges { display: flex; gap: 4px; margin-left: 8px; flex-shrink: 0; }
        .h-badge {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 8px;
            font-weight: 700;
            white-space: nowrap;
        }
        .h-badge-target { background: var(--accent-light); color: #b45309; }
        .h-badge-out    { background: var(--success-light); color: #15803d; }
        .h-chevron { color: var(--border); margin-left: 6px; font-size: 16px; }

        /* â”€â”€ Refresh Bar â”€â”€ */
        .refresh-bar {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 12px;
        }
        .btn-refresh {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            color: var(--primary);
            cursor: pointer;
            transition: all .2s;
        }
        .btn-refresh:active { background: var(--primary-light); }

        /* â”€â”€ Empty State â”€â”€ */
        .empty {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-sub);
        }
        .empty-icon { font-size: 40px; margin-bottom: 10px; }
        .empty-text { font-size: 14px; }

        /* â”€â”€ Forms â”€â”€ */
        .form-card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 22px 18px;
            box-shadow: var(--shadow);
        }
        .form-card h2 { font-size: 18px; font-weight: 800; margin-bottom: 18px; }
        .fg { margin-bottom: 16px; }
        .fl {
            display: block;
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--text);
        }
        .fi {
            width: 100%;
            padding: 11px 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 15px;
            background: #fff;
            transition: border-color .2s;
        }
        .fi:focus { outline: none; border-color: var(--primary); }
        .help { font-size: 12px; color: var(--text-sub); margin-top: 4px; }
        .code-inline {
            background: #f0f0f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }

        .chk-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
        }
        .chk-row input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--primary); }
        .chk-row label { font-size: 14px; cursor: pointer; user-select: none; }

        /* â”€â”€ Buttons â”€â”€ */
        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all .2s;
            margin-bottom: 8px;
            text-align: center;
        }
        .btn:active { transform: scale(.98); }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-success { background: var(--success); color: #fff; }
        .btn-danger  { background: var(--danger);  color: #fff; }
        .btn-sm {
            display: inline-block;
            width: auto;
            padding: 8px 18px;
            font-size: 13px;
            margin-right: 8px;
        }

        /* â”€â”€ Modals â”€â”€ */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.45);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
            justify-content: center;
            align-items: flex-start;
        }
        .modal-overlay.show { display: flex; }
        .modal-box {
            background: var(--card);
            border-radius: var(--radius);
            padding: 22px 18px;
            max-width: 560px;
            width: 100%;
            margin: auto;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,.2);
        }
        .modal-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }
        .modal-title { font-size: 18px; font-weight: 800; color: var(--primary); }
        .modal-x {
            background: none;
            border: none;
            font-size: 26px;
            color: var(--text-sub);
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .detail-row {
            display: flex;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }
        .detail-row:last-child { border-bottom: none; }
        .detail-lbl { font-weight: 700; color: var(--text-sub); min-width: 130px; flex-shrink: 0; }
        .detail-val { color: var(--text); word-break: break-all; }
        .detail-badges { display: flex; gap: 6px; flex-wrap: wrap; margin: 10px 0; }
        .modal-actions { display: flex; gap: 8px; margin-top: 16px; }

        /* â”€â”€ Notification â”€â”€ */
        .toast {
            position: fixed;
            top: 90px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: var(--card);
            padding: 12px 24px;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: all .3s;
            font-size: 14px;
            font-weight: 600;
            max-width: 90%;
            text-align: center;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto; }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error   { border-left: 4px solid var(--danger); }

        /* â”€â”€ Misc â”€â”€ */
        textarea.fi { font-family: inherit; min-height: 90px; resize: vertical; }

        @media (max-width: 400px) {
            .dash-num { font-size: 26px; }
            .h-name { font-size: 14px; }
        }
    </style>
</head>
<body>

<!-- Header -->
<div class="header">
    <h1>ğŸ¥ ç—…é™¢é¡§å®¢ç®¡ç†</h1>
    <div class="header-sub">GitHubé€£æºç‰ˆ v4.0</div>
    <div class="sync-badge" id="syncStatus">æœªæ¥ç¶š</div>
</div>

<!-- Tab Bar -->
<div class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('list', this)">ğŸ“‹ ç—…é™¢ä¸€è¦§</button>
    <button class="tab-btn" onclick="switchTab('add', this)">â• æ–°è¦è¿½åŠ </button>
    <button class="tab-btn" onclick="switchTab('setup', this)">âš™ï¸ è¨­å®š</button>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Detail Modal -->
<div class="modal-overlay" id="detailModal">
    <div class="modal-box">
        <div class="modal-top">
            <div class="modal-title">æ–½è¨­è©³ç´°</div>
            <button class="modal-x" onclick="closeModal('detailModal')">&times;</button>
        </div>
        <div id="detailBody"></div>
        <div class="modal-actions">
            <button class="btn btn-primary btn-sm" onclick="openEditFromDetail()">âœï¸ ç·¨é›†</button>
            <button class="btn btn-danger btn-sm" onclick="deleteFromDetail()">ğŸ—‘ï¸ å‰Šé™¤</button>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal-overlay" id="editModal">
    <div class="modal-box">
        <div class="modal-top">
            <div class="modal-title">æ–½è¨­æƒ…å ±ã®ç·¨é›†</div>
            <button class="modal-x" onclick="closeModal('editModal')">&times;</button>
        </div>
        <div id="editFormWrap"></div>
    </div>
</div>

<div class="container">

    <!-- ç—…é™¢ä¸€è¦§ Tab -->
    <div id="tab-list" class="tab-content active">
        <div class="dash-grid" id="dashGrid"></div>
        <div id="listSubView"></div>
    </div>

    <!-- æ–°è¦è¿½åŠ  Tab -->
    <div id="tab-add" class="tab-content">
        <div class="form-card">
            <h2>æ–°è¦æ–½è¨­ã®ç™»éŒ²</h2>
            <div class="fg">
                <label class="fl">æ–½è¨­å *</label>
                <input type="text" class="fi" id="inp-name" required>
            </div>
            <div class="fg">
                <label class="fl">éƒ½é“åºœçœŒ *</label>
                <input type="text" class="fi" id="inp-pref" required>
            </div>
            <div class="fg">
                <label class="fl">å¸‚ç”ºæ‘ *</label>
                <input type="text" class="fi" id="inp-city" required>
            </div>
            <div class="fg">
                <label class="fl">ä½æ‰€ï¼ˆè©³ç´°ï¼‰</label>
                <input type="text" class="fi" id="inp-addr">
            </div>
            <div class="fg">
                <label class="fl">ä»£è¡¨é›»è©±ç•ªå·</label>
                <input type="tel" class="fi" id="inp-phone">
            </div>
            <div class="fg">
                <label class="fl">æ‰€å±ãƒ‰ã‚¯ã‚¿ãƒ¼</label>
                <input type="text" class="fi" id="inp-doc">
            </div>
            <div class="fg">
                <label class="fl">æ‰€å±çœ‹è­·å¸«</label>
                <input type="text" class="fi" id="inp-nurse">
            </div>
            <div class="fg">
                <label class="fl">æ‰€å±è‡¨åºŠå·¥å­¦æŠ€å£«</label>
                <input type="text" class="fi" id="inp-eng">
            </div>
            <div class="fg">
                <label class="fl">ãã®ä»–</label>
                <input type="text" class="fi" id="inp-other">
            </div>
            <div class="fg">
                <label class="fl">ãƒ¡ãƒ¢</label>
                <textarea class="fi" id="inp-memo"></textarea>
            </div>
            <div class="fg">
                <div class="chk-row">
                    <input type="checkbox" id="inp-outpatient">
                    <label for="inp-outpatient">é€æå¤–æ¥ã‚ã‚Š</label>
                </div>
                <div class="chk-row">
                    <input type="checkbox" id="inp-target">
                    <label for="inp-target">å–¶æ¥­ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ–½è¨­</label>
                </div>
            </div>
            <button class="btn btn-success" onclick="addHospital()">âœ… ç™»éŒ²ã™ã‚‹</button>
        </div>
    </div>

    <!-- è¨­å®š Tab -->
    <div id="tab-setup" class="tab-content">
        <div class="form-card">
            <h2>GitHubé€£æºè¨­å®š</h2>
            <p class="help" style="margin-bottom:18px;">GitHubã¨é€£æºã—ã¦ã€PCã¨iPhoneã§ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•åŒæœŸã—ã¾ã™ã€‚</p>
            <div class="fg">
                <label class="fl">GitHubãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
                <input type="text" class="fi" id="cfgUser" placeholder="your-username">
            </div>
            <div class="fg">
                <label class="fl">ãƒªãƒã‚¸ãƒˆãƒªå</label>
                <input type="text" class="fi" id="cfgRepo" value="hospital-manager">
            </div>
            <div class="fg">
                <label class="fl">Personal Access Token</label>
                <input type="password" class="fi" id="cfgToken" placeholder="ghp_xxxxxxxxxxxxx">
                <div class="help">GitHub â†’ Settings â†’ Developer settings â†’ Personal access tokens â†’ Tokens (classic)<br>æ¨©é™: <span class="code-inline">repo</span> ã«ãƒã‚§ãƒƒã‚¯</div>
            </div>
            <button class="btn btn-primary" onclick="saveCfg()">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
            <button class="btn btn-success" onclick="testConn()">ğŸ”Œ æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
        </div>
    </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let hospitals = [];
let cfg = null;
let currentIdx = -1;
let currentView = null; // null | 'all' | 'pref' | 'out' | 'target'
let dataLoaded = false;
let openPrefs = {};

/* â”€â”€â”€ Util â”€â”€â”€ */
function esc(s) {
    if (!s) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function toast(msg, type) {
    type = type || 'success';
    var t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast ' + type + ' show';
    if (toast._t) clearTimeout(toast._t);
    toast._t = setTimeout(function() { t.classList.remove('show'); }, 2500);
}

function syncBadge(cls, txt) {
    var el = document.getElementById('syncStatus');
    el.className = 'sync-badge ' + cls;
    el.textContent = txt;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function switchTab(name, el) {
    document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
    el.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
    document.getElementById('tab-' + name).classList.add('active');

    if (name === 'list') {
        if (!dataLoaded && cfg) {
            loadFromGitHub();
        } else {
            renderDash();
            renderSubView();
        }
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GITHUB CONFIG
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function saveCfg() {
    var c = {
        username: document.getElementById('cfgUser').value.trim(),
        repo:     document.getElementById('cfgRepo').value.trim(),
        token:    document.getElementById('cfgToken').value.trim()
    };
    if (!c.username || !c.repo || !c.token) { toast('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','error'); return; }
    localStorage.setItem('ghCfg', JSON.stringify(c));
    cfg = c;
    toast('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    syncBadge('synced','è¨­å®šä¿å­˜æ¸ˆã¿');
}

function loadCfg() {
    var s = localStorage.getItem('ghCfg');
    if (s) {
        cfg = JSON.parse(s);
        document.getElementById('cfgUser').value  = cfg.username;
        document.getElementById('cfgRepo').value  = cfg.repo;
        document.getElementById('cfgToken').value  = cfg.token;
        syncBadge('synced','è¨­å®šæ¸ˆã¿');
    }
}

function testConn() {
    if (!cfg) { toast('ã¾ãšè¨­å®šã‚’ä¿å­˜ã—ã¦ãã ã•ã„','error'); return; }
    syncBadge('syncing','æ¥ç¶šä¸­...');
    fetch('https://api.github.com/repos/' + cfg.username + '/' + cfg.repo, {
        headers: { 'Authorization': 'token ' + cfg.token, 'Accept': 'application/vnd.github.v3+json' }
    }).then(function(r) {
        if (r.ok) { toast('âœ… æ¥ç¶šæˆåŠŸï¼'); syncBadge('synced','æ¥ç¶šæˆåŠŸ'); }
        else { toast('âŒ æ¥ç¶šå¤±æ•—','error'); syncBadge('error','æ¥ç¶šå¤±æ•—'); }
    }).catch(function() {
        toast('âŒ æ¥ç¶šå¤±æ•—','error'); syncBadge('error','æ¥ç¶šå¤±æ•—');
    });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GITHUB DATA I/O
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function loadFromGitHub() {
    if (!cfg) return;
    syncBadge('syncing','èª­ã¿è¾¼ã¿ä¸­...');
    fetch('https://api.github.com/repos/' + cfg.username + '/' + cfg.repo + '/contents/hospitals.csv', {
        headers: { 'Authorization': 'token ' + cfg.token, 'Accept': 'application/vnd.github.v3+json' }
    }).then(function(r) {
        if (!r.ok) throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return r.json();
    }).then(function(d) {
        var csv = decodeURIComponent(escape(atob(d.content)));
        parseCSV(csv);
        dataLoaded = true;
        syncBadge('synced','åŒæœŸå®Œäº†');
        renderDash();
        renderSubView();
    }).catch(function(e) {
        syncBadge('error','èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
        toast('èª­ã¿è¾¼ã¿å¤±æ•—: ' + e.message, 'error');
        renderDash();
        renderSubView();
    });
}

function saveToGitHub() {
    if (!cfg) return Promise.resolve(false);
    syncBadge('syncing','ä¿å­˜ä¸­...');

    return fetch('https://api.github.com/repos/' + cfg.username + '/' + cfg.repo + '/contents/hospitals.csv', {
        headers: { 'Authorization': 'token ' + cfg.token, 'Accept': 'application/vnd.github.v3+json' }
    }).then(function(gr) {
        if (gr.ok) return gr.json().then(function(d) { return d.sha; });
        return null;
    }).then(function(sha) {
        var csv = generateCSV();
        var content = btoa(unescape(encodeURIComponent(csv)));
        var body = { message: 'Update hospitals data', content: content };
        if (sha) body.sha = sha;
        return fetch('https://api.github.com/repos/' + cfg.username + '/' + cfg.repo + '/contents/hospitals.csv', {
            method: 'PUT',
            headers: { 'Authorization': 'token ' + cfg.token, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
    }).then(function(ur) {
        if (!ur.ok) throw new Error('ä¿å­˜å¤±æ•—');
        syncBadge('synced','åŒæœŸå®Œäº†');
        return true;
    }).catch(function(e) {
        syncBadge('error','ä¿å­˜ã‚¨ãƒ©ãƒ¼');
        toast('GitHubä¿å­˜å¤±æ•—: ' + e.message, 'error');
        return false;
    });
}

function refreshFromGitHub() {
    if (!cfg) { toast('GitHubè¨­å®šã‚’å®Œäº†ã—ã¦ãã ã•ã„','error'); return; }
    dataLoaded = false;
    loadFromGitHub();
    toast('æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã„ã¾ã™...');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CSV PARSE / GENERATE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var JP_MAP = {
    'ç—…é™¢å':'Name','ä½æ‰€':'Address','éƒ½é“åºœçœŒ':'Prefecture','å¸‚ç”ºæ‘':'City',
    'ä»£è¡¨é›»è©±ç•ªå·':'Phone','æ‰€å±ãƒ‰ã‚¯ã‚¿ãƒ¼':'Doctors','æ‰€å±çœ‹è­·å¸«':'Nurses',
    'æ‰€å±è‡¨åºŠå·¥å­¦æŠ€å£«':'Engineers','ãã®ä»–':'Other','ãƒ¡ãƒ¢':'Memo',
    'é€æå¤–æ¥':'HasOutpatient','ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ':'IsTarget'
};

function parseCSV(text) {
    var lines = text.split('\n').filter(function(l) { return l.trim(); });
    if (!lines.length) return;
    var headers = csvLine(lines[0]);
    hospitals = [];
    for (var i = 1; i < lines.length; i++) {
        var vals = csvLine(lines[i]);
        var h = {};
        headers.forEach(function(hd, j) { h[JP_MAP[hd] || hd] = vals[j] || ''; });
        hospitals.push(h);
    }
}

function csvLine(line) {
    var r = [], c = '', q = false;
    for (var i = 0; i < line.length; i++) {
        var ch = line[i];
        if (ch === '"') {
            if (q && line[i+1] === '"') { c += '"'; i++; }
            else q = !q;
        } else if (ch === ',' && !q) { r.push(c.trim()); c = ''; }
        else c += ch;
    }
    r.push(c.trim());
    return r;
}

function csvEsc(v) {
    if (!v) return '';
    var s = String(v);
    return (s.indexOf(',') >= 0 || s.indexOf('"') >= 0 || s.indexOf('\n') >= 0) ? '"' + s.replace(/"/g,'""') + '"' : s;
}

function generateCSV() {
    var o = 'Name,Address,Prefecture,City,Phone,Doctors,Nurses,Engineers,Other,Memo,HasOutpatient,IsTarget\n';
    hospitals.forEach(function(h) {
        o += [h.Name,h.Address,h.Prefecture,h.City,h.Phone,h.Doctors,h.Nurses,h.Engineers,h.Other,h.Memo,h.HasOutpatient,h.IsTarget].map(function(v) { return csvEsc(v||''); }).join(',') + '\n';
    });
    return o;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD (Stats Grid)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderDash() {
    var total = hospitals.length;
    var prefSet = {};
    hospitals.forEach(function(h) { if (h.Prefecture) prefSet[h.Prefecture] = true; });
    var prefCount = Object.keys(prefSet).length;
    var outCnt = hospitals.filter(function(h) { return h.HasOutpatient === 'Yes'; }).length;
    var tgtCnt = hospitals.filter(function(h) { return h.IsTarget === 'Yes'; }).length;

    document.getElementById('dashGrid').innerHTML =
        '<div class="dash-card c-all ' + (currentView==='all'?'selected':'') + '" onclick="setView(\'all\')">' +
            '<div class="dash-icon">ğŸ¥</div><div class="dash-num">' + total + '</div><div class="dash-label">å…¨æ–½è¨­</div></div>' +
        '<div class="dash-card c-pref ' + (currentView==='pref'?'selected':'') + '" onclick="setView(\'pref\')">' +
            '<div class="dash-icon">ğŸ“</div><div class="dash-num">' + prefCount + '</div><div class="dash-label">éƒ½é“åºœçœŒåˆ¥</div></div>' +
        '<div class="dash-card c-out ' + (currentView==='out'?'selected':'') + '" onclick="setView(\'out\')">' +
            '<div class="dash-icon">ğŸ’‰</div><div class="dash-num">' + outCnt + '</div><div class="dash-label">é€æå¤–æ¥ã‚ã‚Š</div></div>' +
        '<div class="dash-card c-target ' + (currentView==='target'?'selected':'') + '" onclick="setView(\'target\')">' +
            '<div class="dash-icon">ğŸ¯</div><div class="dash-num">' + tgtCnt + '</div><div class="dash-label">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ</div></div>';
}

function setView(v) {
    currentView = v;
    renderDash();
    renderSubView();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SUB-VIEWS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderSubView() {
    var wrap = document.getElementById('listSubView');

    if (!currentView) {
        wrap.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ‘†</div><div class="empty-text">ä¸Šã®ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã—ã¦<br>æ–½è¨­ä¸€è¦§ã‚’è¡¨ç¤ºã—ã¦ãã ã•ã„</div></div>';
        return;
    }

    var html = '';
    if (currentView === 'all')    html = renderAllView();
    if (currentView === 'pref')   html = renderPrefView();
    if (currentView === 'out')    html = renderFilterView('HasOutpatient', 'é€æå¤–æ¥ã‚ã‚Š');
    if (currentView === 'target') html = renderFilterView('IsTarget', 'ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ–½è¨­');
    wrap.innerHTML = html;

    var si = document.getElementById('subSearch');
    if (si) {
        si.addEventListener('input', function(e) { onSubSearch(e.target.value); });
    }
}

/* â”€â”€ All â”€â”€ */
function renderAllView() {
    var refreshBtn = cfg ? '<div class="refresh-bar"><button class="btn-refresh" onclick="refreshFromGitHub()">ğŸ”„ GitHubã‹ã‚‰æ›´æ–°</button></div>' : '';
    var html = '<div class="view-header"><div class="view-title">å…¨æ–½è¨­ä¸€è¦§</div><div class="view-count">' + hospitals.length + 'ä»¶</div></div>' +
        refreshBtn +
        '<div class="search-wrap"><input type="text" class="search-input" id="subSearch" placeholder="æ–½è¨­åãƒ»ä½æ‰€ã§æ¤œç´¢..."></div>' +
        '<div id="subList">' + renderCardList(hospitals) + '</div>';
    return html;
}

/* â”€â”€ Prefecture â”€â”€ */
function renderPrefView() {
    var map = {};
    hospitals.forEach(function(h, i) {
        var p = h.Prefecture || 'ï¼ˆæœªè¨­å®šï¼‰';
        if (!map[p]) map[p] = [];
        map[p].push({ h: h, idx: i });
    });
    var sorted = Object.keys(map).sort(function(a, b) { return map[b].length - map[a].length; });

    var html = '<div class="view-header"><div class="view-title">éƒ½é“åºœçœŒåˆ¥</div><div class="view-count">' + sorted.length + 'åœ°åŸŸ</div></div>';

    sorted.forEach(function(pref) {
        var list = map[pref];
        var isOpen = openPrefs[pref];
        var safePref = esc(pref);
        html += '<div class="pref-group">' +
            '<div class="pref-header ' + (isOpen?'open':'') + '" onclick="togglePref(this, \'' + safePref.replace(/'/g, "\\'") + '\')">' +
                '<span>ğŸ“ ' + safePref + '</span>' +
                '<span><span class="pref-count">' + list.length + '</span><span class="pref-arrow">â–¼</span></span>' +
            '</div>' +
            '<div class="pref-items ' + (isOpen?'open':'') + '">';
        list.forEach(function(item) {
            html += cardInGroup(item.h, item.idx);
        });
        html += '</div></div>';
    });

    return html;
}

/* â”€â”€ Filtered (outpatient / target) â”€â”€ */
function renderFilterView(key, label) {
    var filtered = [];
    hospitals.forEach(function(h, i) {
        if (h[key] === 'Yes') filtered.push({ h: h, idx: i });
    });

    var html = '<div class="view-header"><div class="view-title">' + esc(label) + '</div><div class="view-count">' + filtered.length + 'ä»¶</div></div>' +
        '<div class="search-wrap"><input type="text" class="search-input" id="subSearch" placeholder="æ–½è¨­åã§æ¤œç´¢..."></div>' +
        '<div id="subList">';

    if (!filtered.length) {
        html += '<div class="empty"><div class="empty-icon">ğŸ“­</div><div class="empty-text">è©²å½“ã™ã‚‹æ–½è¨­ãŒã‚ã‚Šã¾ã›ã‚“</div></div>';
    } else {
        filtered.forEach(function(item) {
            html += cardStandalone(item.h, item.idx);
        });
    }
    html += '</div>';
    return html;
}

/* â”€â”€ Card renderers â”€â”€ */
function renderCardList(list) {
    if (!list.length) return '<div class="empty"><div class="empty-icon">ğŸ“­</div><div class="empty-text">æ–½è¨­ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“<br>ã€Œæ–°è¦è¿½åŠ ã€ã‚¿ãƒ–ã‹ã‚‰ç™»éŒ²ã—ã¦ãã ã•ã„</div></div>';
    var html = '';
    list.forEach(function(h, i) {
        html += cardStandalone(h, i);
    });
    return html;
}

function cardStandalone(h, idx) {
    var badges = badgesHTML(h);
    return '<div class="h-card-standalone" onclick="showDetail(' + idx + ')">' +
        '<div class="h-info">' +
            '<div class="h-name">' + esc(h.Name || 'ï¼ˆæ–½è¨­åãªã—ï¼‰') + '</div>' +
            '<div class="h-sub">' + esc(h.Prefecture||'') + ' ' + esc(h.City||'') + (h.Phone ? ' ãƒ» ' + esc(h.Phone) : '') + '</div>' +
        '</div>' +
        badges +
        '<span class="h-chevron">â€º</span></div>';
}

function cardInGroup(h, idx) {
    var badges = badgesHTML(h);
    return '<div class="h-card" onclick="showDetail(' + idx + ')">' +
        '<div class="h-info">' +
            '<div class="h-name">' + esc(h.Name || 'ï¼ˆæ–½è¨­åãªã—ï¼‰') + '</div>' +
            '<div class="h-sub">' + esc(h.City||'') + (h.Phone ? ' ãƒ» ' + esc(h.Phone) : '') + '</div>' +
        '</div>' +
        badges +
        '<span class="h-chevron">â€º</span></div>';
}

function badgesHTML(h) {
    var b = '';
    if (h.IsTarget === 'Yes') b += '<span class="h-badge h-badge-target">ğŸ¯</span>';
    if (h.HasOutpatient === 'Yes') b += '<span class="h-badge h-badge-out">ğŸ’‰</span>';
    return b ? '<div class="h-badges">' + b + '</div>' : '';
}

/* â”€â”€ Prefecture toggle â”€â”€ */
function togglePref(el, pref) {
    el.classList.toggle('open');
    var items = el.nextElementSibling;
    items.classList.toggle('open');
    openPrefs[pref] = items.classList.contains('open');
}

/* â”€â”€ Search within sub-view â”€â”€ */
function onSubSearch(kw) {
    var listEl = document.getElementById('subList');
    if (!listEl) return;

    var source = [];
    if (currentView === 'out') {
        hospitals.forEach(function(h,i) { if (h.HasOutpatient==='Yes') source.push({h:h, idx:i}); });
    } else if (currentView === 'target') {
        hospitals.forEach(function(h,i) { if (h.IsTarget==='Yes') source.push({h:h, idx:i}); });
    } else {
        hospitals.forEach(function(h,i) { source.push({h:h, idx:i}); });
    }

    if (!kw) {
        var html = '';
        if (!source.length) {
            html = '<div class="empty"><div class="empty-icon">ğŸ“­</div><div class="empty-text">è©²å½“ãªã—</div></div>';
        } else {
            source.forEach(function(item) { html += cardStandalone(item.h, item.idx); });
        }
        listEl.innerHTML = html;
        return;
    }

    var filtered = source.filter(function(item) {
        var h = item.h;
        return (h.Name||'').indexOf(kw)>=0 || (h.Prefecture||'').indexOf(kw)>=0 ||
               (h.City||'').indexOf(kw)>=0 || (h.Address||'').indexOf(kw)>=0;
    });

    if (filtered.length) {
        var fhtml = '';
        filtered.forEach(function(item) { fhtml += cardStandalone(item.h, item.idx); });
        listEl.innerHTML = fhtml;
    } else {
        listEl.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ”</div><div class="empty-text">è©²å½“ã™ã‚‹æ–½è¨­ãŒã‚ã‚Šã¾ã›ã‚“</div></div>';
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DETAIL MODAL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showDetail(idx) {
    currentIdx = idx;
    var h = hospitals[idx];
    if (!h) return;

    var rows = [
        ['ğŸ“ æ‰€åœ¨åœ°', (h.Prefecture||'') + ' ' + (h.City||'')],
        ['ä½æ‰€ï¼ˆè©³ç´°ï¼‰', h.Address],
        ['ğŸ“ é›»è©±', h.Phone],
        ['ğŸ‘¨â€âš•ï¸ ãƒ‰ã‚¯ã‚¿ãƒ¼', h.Doctors],
        ['ğŸ‘©â€âš•ï¸ çœ‹è­·å¸«', h.Nurses],
        ['ğŸ”§ è‡¨åºŠå·¥å­¦æŠ€å£«', h.Engineers],
        ['ãã®ä»–', h.Other],
        ['ğŸ“ ãƒ¡ãƒ¢', h.Memo]
    ];

    var badges = '';
    if (h.IsTarget === 'Yes') badges += '<span class="h-badge h-badge-target" style="font-size:12px;padding:4px 12px;">ğŸ¯ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ</span>';
    if (h.HasOutpatient === 'Yes') badges += '<span class="h-badge h-badge-out" style="font-size:12px;padding:4px 12px;">ğŸ’‰ é€æå¤–æ¥</span>';

    var html = '<div style="font-size:20px;font-weight:800;margin-bottom:6px;">' + esc(h.Name||'') + '</div>';
    if (badges) html += '<div class="detail-badges">' + badges + '</div>';

    rows.forEach(function(row) {
        var lbl = row[0], val = row[1];
        if (!val) return;
        if (lbl === 'ğŸ“ é›»è©±') {
            html += '<div class="detail-row"><div class="detail-lbl">' + lbl + '</div><div class="detail-val"><a href="tel:' + esc(val) + '">' + esc(val) + '</a></div></div>';
        } else {
            html += '<div class="detail-row"><div class="detail-lbl">' + lbl + '</div><div class="detail-val">' + esc(val) + '</div></div>';
        }
    });

    document.getElementById('detailBody').innerHTML = html;
    document.getElementById('detailModal').classList.add('show');
}

function closeModal(id) { document.getElementById(id).classList.remove('show'); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EDIT MODAL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openEditFromDetail() {
    closeModal('detailModal');
    openEdit(currentIdx);
}

function openEdit(idx) {
    currentIdx = idx;
    var h = hospitals[idx];
    if (!h) return;

    var fields = [
        ['æ–½è¨­å *','ed-name','text', h.Name],
        ['éƒ½é“åºœçœŒ *','ed-pref','text', h.Prefecture],
        ['å¸‚ç”ºæ‘ *','ed-city','text', h.City],
        ['ä½æ‰€ï¼ˆè©³ç´°ï¼‰','ed-addr','text', h.Address],
        ['ä»£è¡¨é›»è©±ç•ªå·','ed-phone','tel', h.Phone],
        ['æ‰€å±ãƒ‰ã‚¯ã‚¿ãƒ¼','ed-doc','text', h.Doctors],
        ['æ‰€å±çœ‹è­·å¸«','ed-nurse','text', h.Nurses],
        ['æ‰€å±è‡¨åºŠå·¥å­¦æŠ€å£«','ed-eng','text', h.Engineers],
        ['ãã®ä»–','ed-other','text', h.Other]
    ];

    var html = '';
    fields.forEach(function(f) {
        html += '<div class="fg"><label class="fl">' + f[0] + '</label><input type="' + f[2] + '" class="fi" id="' + f[1] + '" value="' + esc(f[3]||'') + '"></div>';
    });
    html += '<div class="fg"><label class="fl">ãƒ¡ãƒ¢</label><textarea class="fi" id="ed-memo">' + esc(h.Memo||'') + '</textarea></div>';
    html += '<div class="fg">' +
        '<div class="chk-row"><input type="checkbox" id="ed-out" ' + (h.HasOutpatient==='Yes'?'checked':'') + '><label for="ed-out">é€æå¤–æ¥ã‚ã‚Š</label></div>' +
        '<div class="chk-row"><input type="checkbox" id="ed-tgt" ' + (h.IsTarget==='Yes'?'checked':'') + '><label for="ed-tgt">å–¶æ¥­ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ–½è¨­</label></div>' +
    '</div>';
    html += '<button class="btn btn-success" onclick="saveEdit()">ğŸ’¾ ä¿å­˜ã™ã‚‹</button>';
    html += '<button class="btn btn-danger" onclick="deleteFromEdit()">ğŸ—‘ï¸ ã“ã®æ–½è¨­ã‚’å‰Šé™¤</button>';

    document.getElementById('editFormWrap').innerHTML = html;
    document.getElementById('editModal').classList.add('show');
}

function saveEdit() {
    if (currentIdx < 0) return;
    hospitals[currentIdx] = {
        Name:           document.getElementById('ed-name').value,
        Prefecture:     document.getElementById('ed-pref').value,
        City:           document.getElementById('ed-city').value,
        Address:        document.getElementById('ed-addr').value,
        Phone:          document.getElementById('ed-phone').value,
        Doctors:        document.getElementById('ed-doc').value,
        Nurses:         document.getElementById('ed-nurse').value,
        Engineers:      document.getElementById('ed-eng').value,
        Other:          document.getElementById('ed-other').value,
        Memo:           document.getElementById('ed-memo').value,
        HasOutpatient:  document.getElementById('ed-out').checked ? 'Yes' : '',
        IsTarget:       document.getElementById('ed-tgt').checked ? 'Yes' : ''
    };
    closeModal('editModal');
    if (cfg) saveToGitHub();
    renderDash();
    renderSubView();
    toast('æ–½è¨­æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DELETE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function deleteFromDetail() {
    if (!confirm('ã“ã®æ–½è¨­ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
    hospitals.splice(currentIdx, 1);
    closeModal('detailModal');
    if (cfg) saveToGitHub();
    renderDash();
    renderSubView();
    toast('æ–½è¨­ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
}

function deleteFromEdit() {
    if (!confirm('ã“ã®æ–½è¨­ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
    hospitals.splice(currentIdx, 1);
    closeModal('editModal');
    if (cfg) saveToGitHub();
    renderDash();
    renderSubView();
    toast('æ–½è¨­ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADD HOSPITAL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addHospital() {
    var name = document.getElementById('inp-name').value.trim();
    var pref = document.getElementById('inp-pref').value.trim();
    var city = document.getElementById('inp-city').value.trim();
    if (!name || !pref || !city) { toast('æ–½è¨­åãƒ»éƒ½é“åºœçœŒãƒ»å¸‚ç”ºæ‘ã¯å¿…é ˆã§ã™','error'); return; }

    hospitals.push({
        Name:           name,
        Prefecture:     pref,
        City:           city,
        Address:        document.getElementById('inp-addr').value,
        Phone:          document.getElementById('inp-phone').value,
        Doctors:        document.getElementById('inp-doc').value,
        Nurses:         document.getElementById('inp-nurse').value,
        Engineers:      document.getElementById('inp-eng').value,
        Other:          document.getElementById('inp-other').value,
        Memo:           document.getElementById('inp-memo').value,
        HasOutpatient:  document.getElementById('inp-outpatient').checked ? 'Yes' : '',
        IsTarget:       document.getElementById('inp-target').checked ? 'Yes' : ''
    });

    if (cfg) saveToGitHub();

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
    var ids = ['inp-name','inp-pref','inp-city','inp-addr','inp-phone','inp-doc','inp-nurse','inp-eng','inp-other','inp-memo'];
    ids.forEach(function(id) { document.getElementById(id).value = ''; });
    document.getElementById('inp-outpatient').checked = false;
    document.getElementById('inp-target').checked = false;

    renderDash();
    renderSubView();
    toast('æ–½è¨­ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('DOMContentLoaded', function() {
    loadCfg();
    if (cfg) {
        loadFromGitHub();
    } else {
        renderDash();
        renderSubView();
    }
});
</script>
</body>
</html>
