<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Kintone ãƒ‡ãƒ¼ã‚¿ã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root {
            --primary: #1a6fc4;
            --primary-light: #e8f1fa;
            --secondary: #4a5a8a;
            --accent: #e67e22;
            --accent-light: #fef3e6;
            --success: #27ae60;
            --danger: #e74c3c;
            --bg: #f0f2f5;
            --card: #fff;
            --text: #1a1a2e;
            --text-sub: #6b7280;
            --border: #e2e5ea;
            --shadow: 0 1px 3px rgba(0,0,0,.06);
            --shadow-md: 0 4px 12px rgba(0,0,0,.08);
            --radius: 14px;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }
        .header {
            background: linear-gradient(135deg, #1a3a5c 0%, #1a6fc4 60%, #2980b9 100%);
            color: #fff;
            padding: 24px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 { font-size: 22px; font-weight: 800; }
        .header-sub { font-size: 12px; opacity: .75; margin-top: 4px; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        .tab-bar {
            display: flex;
            background: var(--card);
            border-bottom: 2px solid var(--border);
            margin-bottom: 20px;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        .tab-btn {
            flex: 1;
            padding: 14px 16px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 700;
            color: var(--text-sub);
            cursor: pointer;
            transition: all .2s;
            white-space: nowrap;
        }
        .tab-btn.active {
            color: var(--primary);
            background: var(--primary-light);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 16px;
        }
        .form-card h2 { font-size: 16px; font-weight: 800; margin-bottom: 14px; color: var(--primary); }
        .fg { margin-bottom: 16px; }
        .fl { display: block; font-size: 13px; font-weight: 700; margin-bottom: 6px; color: var(--text); }
        .file-input-wrap {
            position: relative;
            border: 2px dashed var(--border);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all .2s;
            background: var(--bg);
        }
        .file-input-wrap:hover { border-color: var(--primary); background: var(--primary-light); }
        .file-input-wrap.drag-over { border-color: var(--primary); background: var(--primary-light); }
        .file-input-wrap input[type="file"] { display: none; }
        .file-input-label { cursor: pointer; display: block; }
        .file-icon { font-size: 32px; margin-bottom: 8px; }
        .file-text { font-size: 14px; font-weight: 600; color: var(--text); }
        .file-hint { font-size: 12px; color: var(--text-sub); margin-top: 4px; }
        .btn {
            display: block;
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all .2s;
            margin-top: 8px;
            text-align: center;
            text-decoration: none;
        }
        .btn:active { transform: scale(.98); }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-success { background: var(--success); color: #fff; }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn:disabled { opacity: .5; cursor: not-allowed; }
        .btn-sm { padding: 8px 14px; display: inline-block; width: auto; margin-right: 8px; margin-top: 0; }
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            font-size: 12px;
        }
        .preview-table th {
            background: var(--primary);
            color: #fff;
            padding: 8px;
            text-align: left;
            font-weight: 700;
        }
        .preview-table td {
            padding: 8px;
            border-bottom: 1px solid var(--border);
            word-break: break-all;
        }
        .preview-table tr:last-child td { border-bottom: none; }
        .status-box {
            background: var(--success);
            color: #fff;
            padding: 12px 14px;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 13px;
            font-weight: 600;
        }
        .status-box.error { background: var(--danger); }
        .status-box.info { background: var(--primary); }
        .settings-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .settings-group input { width: 100%; }
        .hidden { display: none !important; }
        .info-text { font-size: 12px; color: var(--text-sub); margin-top: 4px; }
        .btn-group { display: flex; gap: 8px; margin-top: 12px; }
        .btn-group .btn { margin: 0; flex: 1; }
        @media (max-width: 600px) {
            .settings-group { grid-template-columns: 1fr; }
            .container { padding: 12px; }
            .form-card { padding: 14px; }
        }
    </style>
</head>
<body>

<div class="header">
    <h1>ğŸ“Š Kintone ãƒ‡ãƒ¼ã‚¿ã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼</h1>
    <div class="header-sub">Kintone Excel â†” ã‚¢ãƒ—ãƒªCSV è‡ªå‹•å¤‰æ›ãƒ„ãƒ¼ãƒ«</div>
</div>

<div class="container">
    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('excel2csv')">ğŸ”„ Excel â†’ CSV</button>
        <button class="tab-btn" onclick="switchTab('csv2excel')">ğŸ“Š CSV â†’ Excel</button>
        <button class="tab-btn" onclick="switchTab('settings')">âš™ï¸ è¨­å®š</button>
    </div>

    <!-- Tab 1: Excel â†’ CSV -->
    <div id="tab-excel2csv" class="tab-content active">
        <div class="form-card">
            <h2>ğŸ¥ æ–½è¨­ç®¡ç† (Excel â†’ CSV)</h2>
            <div class="fg">
                <label class="fl">æ–½è¨­ç®¡ç†Excelãƒ•ã‚¡ã‚¤ãƒ«</label>
                <div class="file-input-wrap" id="facility-drop" ondrop="handleFacilityDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <label class="file-input-label">
                        <div class="file-icon">ğŸ“</div>
                        <div class="file-text">01_æ–½è¨­ç®¡ç†_*.xlsx ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
                        <div class="file-hint">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</div>
                        <input type="file" id="facility-file" accept=".xlsx,.xls" onchange="handleFacilityFile(event)">
                    </label>
                </div>
            </div>
            <div id="facility-preview"></div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="convertFacilityExcel()" id="btn-facility-csv" disabled>CSVã«å¤‰æ›</button>
                <button class="btn btn-success" onclick="downloadFacilityCSV()" id="btn-facility-download" disabled>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            </div>
        </div>

        <div class="form-card">
            <h2>ğŸ‘¥ åŒ»ç™‚å¾“äº‹è€…ç®¡ç† (Excel â†’ CSV)</h2>
            <div class="fg">
                <label class="fl">åŒ»ç™‚å¾“äº‹è€…Excelãƒ•ã‚¡ã‚¤ãƒ«</label>
                <div class="file-input-wrap" id="staff-drop" ondrop="handleStaffDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <label class="file-input-label">
                        <div class="file-icon">ğŸ“</div>
                        <div class="file-text">03_åŒ»ç™‚è€…åœ¨ç±ç®¡ç†_*.xlsx ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
                        <div class="file-hint">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</div>
                        <input type="file" id="staff-file" accept=".xlsx,.xls" onchange="handleStaffFile(event)">
                    </label>
                </div>
            </div>
            <div id="staff-preview"></div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="convertStaffExcel()" id="btn-staff-csv" disabled>CSVã«å¤‰æ›</button>
                <button class="btn btn-success" onclick="downloadStaffCSV()" id="btn-staff-download" disabled>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            </div>
        </div>
    </div>

    <!-- Tab 2: CSV â†’ Excel -->
    <div id="tab-csv2excel" class="tab-content">
        <div class="form-card">
            <h2>ğŸ¥ æ–½è¨­CSV â†’ Excel</h2>
            <div class="fg">
                <label class="fl">æ–½è¨­CSVãƒ•ã‚¡ã‚¤ãƒ«</label>
                <div class="file-input-wrap" id="csv-facility-drop" ondrop="handleCSVFacilityDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <label class="file-input-label">
                        <div class="file-icon">ğŸ“‹</div>
                        <div class="file-text">hospitals.csv ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
                        <div class="file-hint">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</div>
                        <input type="file" id="csv-facility-file" accept=".csv" onchange="handleCSVFacilityFile(event)">
                    </label>
                </div>
            </div>
            <div id="csv-facility-preview"></div>
            <button class="btn btn-success" onclick="downloadFacilityXLSX()" id="btn-xlsx-facility" disabled>Excelãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        </div>

        <div class="form-card">
            <h2>ğŸ‘¥ åŒ»ç™‚å¾“äº‹è€…CSV â†’ Excel</h2>
            <div class="fg">
                <label class="fl">åŒ»ç™‚å¾“äº‹è€…CSVãƒ•ã‚¡ã‚¤ãƒ«</label>
                <div class="file-input-wrap" id="csv-staff-drop" ondrop="handleCSVStaffDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <label class="file-input-label">
                        <div class="file-icon">ğŸ“‹</div>
                        <div class="file-text">staff.csv ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
                        <div class="file-hint">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</div>
                        <input type="file" id="csv-staff-file" accept=".csv" onchange="handleCSVStaffFile(event)">
                    </label>
                </div>
            </div>
            <div id="csv-staff-preview"></div>
            <button class="btn btn-success" onclick="downloadStaffXLSX()" id="btn-xlsx-staff" disabled>Excelãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        </div>
    </div>

    <!-- Tab 3: Settings -->
    <div id="tab-settings" class="tab-content">
        <div class="form-card">
            <h2>GitHub é€£æºè¨­å®š</h2>
            <div class="fg">
                <label class="fl">GitHubãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
                <input type="text" id="github-user" placeholder="ä¾‹: username" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;">
            </div>
            <div class="fg">
                <label class="fl">ãƒªãƒã‚¸ãƒˆãƒªå</label>
                <input type="text" id="github-repo" placeholder="ä¾‹: hospital-manager" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;">
            </div>
            <div class="fg">
                <label class="fl">Personal Access Token</label>
                <input type="password" id="github-token" placeholder="ghp_..." style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px;">
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveGitHubSettings()">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
                <button class="btn btn-primary" onclick="testGitHubConnection()">ğŸ”Œ æ¥ç¶šã‚’ãƒ†ã‚¹ãƒˆ</button>
            </div>
            <div id="github-status"></div>
        </div>

        <div class="form-card">
            <h2>â„¹ï¸ ä½¿ã„æ–¹</h2>
            <div style="font-size: 13px; line-height: 1.8; color: var(--text-sub);">
                <p style="margin-bottom: 8px;"><strong>1. Excel â†’ CSV:</strong></p>
                <ul style="margin-left: 16px; margin-bottom: 12px;">
                    <li>Kintoneã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸexcel ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</li>
                    <li>è‡ªå‹•ã§åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’è¡Œã„ã€ã‚¢ãƒ—ãƒªç”¨CSVã«å¤‰æ›</li>
                    <li>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦GitHubã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</li>
                </ul>
                <p style="margin-bottom: 8px;"><strong>2. CSV â†’ Excel:</strong></p>
                <ul style="margin-left: 16px;">
                    <li>ã‚¢ãƒ—ãƒªã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸCSVã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</li>
                    <li>Excelå½¢å¼ã«å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let facilityData = null, staffData = null;
let csvFacilityData = null, csvStaffData = null;
let ghSettings = { user: '', repo: '', token: '' };

// åˆæœŸåŒ–
function init() {
    loadGitHubSettings();
}

// UIæ“ä½œ
function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tabName).classList.add('active');
    event.target.classList.add('active');
}

function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

function handleDragLeave(e) {
    e.currentTarget.classList.remove('drag-over');
}

// æ–½è¨­Excelãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
function handleFacilityFile(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (evt) => {
            try {
                const wb = XLSX.read(evt.target.result, { type: 'binary' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                facilityData = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
                showFacilityPreview();
                document.getElementById('btn-facility-csv').disabled = false;
            } catch (err) {
                showStatus('facility-preview', 'ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
            }
        };
        reader.readAsBinaryString(file);
    }
}

function handleFacilityDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file) {
        document.getElementById('facility-file').files = e.dataTransfer.files;
        handleFacilityFile({ target: { files: e.dataTransfer.files } });
    }
}

function showFacilityPreview() {
    if (!facilityData || facilityData.length < 2) return;
    let html = '<p class="info-text">ğŸ“„ ' + facilityData.length + ' è¡Œã‚’æ¤œå‡ºï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼å«ã‚€ï¼‰</p>';
    html += '<table class="preview-table"><thead><tr>';
    facilityData[0].slice(0, 8).forEach(h => html += '<th>' + (h || '(ç©º)') + '</th>');
    html += '</tr></thead><tbody>';
    facilityData.slice(1, 3).forEach(row => {
        html += '<tr>';
        row.slice(0, 8).forEach(v => html += '<td>' + (v || '') + '</td>');
        html += '</tr>';
    });
    html += '</tbody></table>';
    document.getElementById('facility-preview').innerHTML = html;
}

function convertFacilityExcel() {
    if (!facilityData) return showStatus('facility-preview', 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
    try {
        // åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°: D=ç—…é™¢å(3), G=ä½æ‰€(6), E=éƒ½é“åºœçœŒ(4), F=å¸‚åŒºç”ºæ‘(5), H=é›»è©±(7)
        const mapped = [];
        for (let i = 1; i < facilityData.length; i++) {
            const row = facilityData[i];
            if (row[3]) {  // ç—…é™¢åãŒã‚ã‚‹å ´åˆã®ã¿
                mapped.push({
                    Name: (row[3] || '').toString(),
                    Address: (row[6] || '').toString(),
                    Prefecture: (row[4] || '').toString(),
                    City: (row[5] || '').toString(),
                    Phone: (row[7] || '').toString(),
                    Other: '',
                    Memo: '',
                    Targets: '',
                    BedCount: '',
                    ICUBeds: '',
                    DialysisBeds: '',
                    DialysisPatients: '',
                    DialysisRenewalYear: ''
                });
            }
        }
        facilityData = mapped;
        showStatus('facility-preview', 'âœ… ' + mapped.length + 'ä»¶ã®æ–½è¨­ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›ã—ã¾ã—ãŸ', 'success');
        document.getElementById('btn-facility-download').disabled = false;
    } catch (err) {
        showStatus('facility-preview', 'å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
    }
}

function downloadFacilityCSV() {
    if (!facilityData || facilityData.length === 0) return;
    const headers = 'Name,Address,Prefecture,City,Phone,Other,Memo,Targets,BedCount,ICUBeds,DialysisBeds,DialysisPatients,DialysisRenewalYear';
    let csv = '\ufeff' + headers + '\n';
    facilityData.forEach(row => {
        const values = [
            row.Name || '', row.Address || '', row.Prefecture || '', row.City || '', row.Phone || '',
            row.Other || '', row.Memo || '', row.Targets || '', row.BedCount || '', row.ICUBeds || '',
            row.DialysisBeds || '', row.DialysisPatients || '', row.DialysisRenewalYear || ''
        ];
        csv += values.map(v => {
            if ((v + '').includes(',') || (v + '').includes('"')) return '"' + (v + '').replace(/"/g, '""') + '"';
            return v;
        }).join(',') + '\n';
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'hospitals.csv';
    link.click();
    showStatus('facility-preview', 'âœ… hospitals.csv ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
}

// åŒ»ç™‚å¾“äº‹è€…Excelãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
function handleStaffFile(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (evt) => {
            try {
                const wb = XLSX.read(evt.target.result, { type: 'binary' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                staffData = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
                showStaffPreview();
                document.getElementById('btn-staff-csv').disabled = false;
            } catch (err) {
                showStatus('staff-preview', 'ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
            }
        };
        reader.readAsBinaryString(file);
    }
}

function handleStaffDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file) {
        document.getElementById('staff-file').files = e.dataTransfer.files;
        handleStaffFile({ target: { files: e.dataTransfer.files } });
    }
}

function showStaffPreview() {
    if (!staffData || staffData.length < 2) return;
    let html = '<p class="info-text">ğŸ“„ ' + staffData.length + ' è¡Œã‚’æ¤œå‡ºï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼å«ã‚€ï¼‰</p>';
    html += '<table class="preview-table"><thead><tr>';
    staffData[0].slice(0, 8).forEach(h => html += '<th>' + (h || '(ç©º)') + '</th>');
    html += '</tr></thead><tbody>';
    staffData.slice(1, 3).forEach(row => {
        html += '<tr>';
        row.slice(0, 8).forEach(v => html += '<td>' + (v || '') + '</td>');
        html += '</tr>';
    });
    html += '</tbody></table>';
    document.getElementById('staff-preview').innerHTML = html;
}

function convertStaffExcel() {
    if (!staffData) return showStatus('staff-preview', 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
    try {
        // åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°: B=æ–½è¨­å(1), F=åå‰(5), G=éƒ¨é–€(6), E=è·ç¨®(4), C=è¨ºç™‚ç§‘(2)
        const mapped = [];
        let id = 1;
        for (let i = 1; i < staffData.length; i++) {
            const row = staffData[i];
            if (row[5]) {  // åå‰ãŒã‚ã‚‹å ´åˆã®ã¿
                const hospital = (row[1] || '').toString();
                const name = (row[5] || '').toString();
                const jobType = (row[6] || '').toString();
                const specialty = (row[4] || '').toString();
                const department = (row[2] || '').toString();

                let memo = '';
                if (specialty) memo += 'Specialty: ' + specialty;
                if (department && department !== jobType) memo += (memo ? ' | ' : '') + 'Department: ' + department;

                mapped.push({
                    ID: 'S' + String(id).padStart(4, '0'),
                    Name: name,
                    HospitalName: hospital,
                    JobType: jobType,
                    Phone: '',
                    Email: '',
                    Memo: memo
                });
                id++;
            }
        }
        staffData = mapped;
        showStatus('staff-preview', 'âœ… ' + mapped.length + 'ä»¶ã®åŒ»ç™‚å¾“äº‹è€…ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›ã—ã¾ã—ãŸ', 'success');
        document.getElementById('btn-staff-download').disabled = false;
    } catch (err) {
        showStatus('staff-preview', 'å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
    }
}

function downloadStaffCSV() {
    if (!staffData || staffData.length === 0) return;
    const headers = 'ID,Name,HospitalName,JobType,Phone,Email,Memo';
    let csv = '\ufeff' + headers + '\n';
    staffData.forEach(row => {
        const values = [row.ID, row.Name, row.HospitalName, row.JobType, row.Phone, row.Email, row.Memo];
        csv += values.map(v => {
            if ((v + '').includes(',') || (v + '').includes('"')) return '"' + (v + '').replace(/"/g, '""') + '"';
            return v;
        }).join(',') + '\n';
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'staff_imported.csv';
    link.click();
    showStatus('staff-preview', 'âœ… staff_imported.csv ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
}

// CSV ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
function handleCSVFacilityFile(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (evt) => {
            try {
                const text = evt.target.result.replace(/^\ufeff/, '');
                const parsed = Papa.parse(text, { header: true });
                csvFacilityData = parsed.data.filter(row => row.Name);
                showCSVFacilityPreview();
                document.getElementById('btn-xlsx-facility').disabled = false;
            } catch (err) {
                showStatus('csv-facility-preview', 'CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
            }
        };
        reader.readAsText(file, 'utf-8');
    }
}

function handleCSVFacilityDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    document.getElementById('csv-facility-file').files = e.dataTransfer.files;
    handleCSVFacilityFile({ target: { files: e.dataTransfer.files } });
}

function showCSVFacilityPreview() {
    if (!csvFacilityData || csvFacilityData.length === 0) return;
    const cols = Object.keys(csvFacilityData[0]).slice(0, 5);
    let html = '<p class="info-text">ğŸ“„ ' + csvFacilityData.length + ' è¡Œã‚’æ¤œå‡º</p>';
    html += '<table class="preview-table"><thead><tr>';
    cols.forEach(c => html += '<th>' + c + '</th>');
    html += '</tr></thead><tbody>';
    csvFacilityData.slice(0, 2).forEach(row => {
        html += '<tr>';
        cols.forEach(c => html += '<td>' + (row[c] || '') + '</td>');
        html += '</tr>';
    });
    html += '</tbody></table>';
    document.getElementById('csv-facility-preview').innerHTML = html;
}

function downloadFacilityXLSX() {
    if (!csvFacilityData || csvFacilityData.length === 0) return;
    const ws_data = [Object.keys(csvFacilityData[0])];
    csvFacilityData.forEach(row => {
        ws_data.push(Object.keys(csvFacilityData[0]).map(k => row[k] || ''));
    });
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    ws['!cols'] = Object.keys(csvFacilityData[0]).map(() => ({ wch: 20 }));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Facilities');
    XLSX.writeFile(wb, 'hospitals.xlsx');
    showStatus('csv-facility-preview', 'âœ… hospitals.xlsx ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
}

// åŒ»ç™‚å¾“äº‹è€…CSVå‡¦ç†
function handleCSVStaffFile(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (evt) => {
            try {
                const text = evt.target.result.replace(/^\ufeff/, '');
                const parsed = Papa.parse(text, { header: true });
                csvStaffData = parsed.data.filter(row => row.Name);
                showCSVStaffPreview();
                document.getElementById('btn-xlsx-staff').disabled = false;
            } catch (err) {
                showStatus('csv-staff-preview', 'CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
            }
        };
        reader.readAsText(file, 'utf-8');
    }
}

function handleCSVStaffDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    document.getElementById('csv-staff-file').files = e.dataTransfer.files;
    handleCSVStaffFile({ target: { files: e.dataTransfer.files } });
}

function showCSVStaffPreview() {
    if (!csvStaffData || csvStaffData.length === 0) return;
    const cols = Object.keys(csvStaffData[0]).slice(0, 5);
    let html = '<p class="info-text">ğŸ“„ ' + csvStaffData.length + ' è¡Œã‚’æ¤œå‡º</p>';
    html += '<table class="preview-table"><thead><tr>';
    cols.forEach(c => html += '<th>' + c + '</th>');
    html += '</tr></thead><tbody>';
    csvStaffData.slice(0, 2).forEach(row => {
        html += '<tr>';
        cols.forEach(c => html += '<td>' + (row[c] || '') + '</td>');
        html += '</tr>';
    });
    html += '</tbody></table>';
    document.getElementById('csv-staff-preview').innerHTML = html;
}

function downloadStaffXLSX() {
    if (!csvStaffData || csvStaffData.length === 0) return;
    const ws_data = [Object.keys(csvStaffData[0])];
    csvStaffData.forEach(row => {
        ws_data.push(Object.keys(csvStaffData[0]).map(k => row[k] || ''));
    });
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    ws['!cols'] = Object.keys(csvStaffData[0]).map(() => ({ wch: 20 }));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Staff');
    XLSX.writeFile(wb, 'staff.xlsx');
    showStatus('csv-staff-preview', 'âœ… staff.xlsx ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
}

// GitHubè¨­å®š
function loadGitHubSettings() {
    const saved = localStorage.getItem('ghSettings');
    if (saved) {
        ghSettings = JSON.parse(saved);
        document.getElementById('github-user').value = ghSettings.user;
        document.getElementById('github-repo').value = ghSettings.repo;
        document.getElementById('github-token').value = ghSettings.token;
    }
}

function saveGitHubSettings() {
    ghSettings.user = document.getElementById('github-user').value.trim();
    ghSettings.repo = document.getElementById('github-repo').value.trim();
    ghSettings.token = document.getElementById('github-token').value.trim();

    if (!ghSettings.user || !ghSettings.repo || !ghSettings.token) {
        showStatus('github-status', 'âš ï¸ å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
    }

    localStorage.setItem('ghSettings', JSON.stringify(ghSettings));
    showStatus('github-status', 'âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
}

async function testGitHubConnection() {
    if (!ghSettings.user || !ghSettings.repo || !ghSettings.token) {
        showStatus('github-status', 'âš ï¸ å…ˆã«è¨­å®šã‚’ä¿å­˜ã—ã¦ãã ã•ã„', 'error');
        return;
    }

    try {
        const response = await fetch(`https://api.github.com/repos/${ghSettings.user}/${ghSettings.repo}`, {
            headers: { Authorization: `token ${ghSettings.token}` }
        });
        if (response.ok) {
            showStatus('github-status', 'âœ… GitHubæ¥ç¶šæˆåŠŸï¼', 'success');
        } else if (response.status === 401) {
            showStatus('github-status', 'âŒ ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™', 'error');
        } else if (response.status === 404) {
            showStatus('github-status', 'âŒ ãƒªãƒã‚¸ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
        } else {
            showStatus('github-status', 'âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼: ' + response.status, 'error');
        }
    } catch (err) {
        showStatus('github-status', 'âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ' + err.message, 'error');
    }
}

// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
function showStatus(elementId, message, type) {
    const el = document.getElementById(elementId);
    if (el) {
        const className = type === 'error' ? 'status-box error' : type === 'success' ? 'status-box' : 'status-box info';
        el.innerHTML = '<div class="' + className + '">' + message + '</div>';
    }
}

// åˆæœŸåŒ–å®Ÿè¡Œ
window.addEventListener('load', init);
</script>

</body>
</html>
